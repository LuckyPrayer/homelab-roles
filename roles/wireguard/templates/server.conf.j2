# WireGuard Server Configuration
# Generated by Ansible - Do not edit manually
# Host: {{ inventory_hostname }}
# Mode: Server

[Interface]
# Server private key (keep secret!)
PrivateKey = {{ wireguard_server_private_key }}

# Server address in the VPN network
Address = {{ wireguard_server_address }}

# UDP port to listen on
ListenPort = {{ wireguard_port }}

{% if wireguard_mtu is defined and wireguard_mtu %}
# MTU for the interface
MTU = {{ wireguard_mtu }}
{% endif %}

{% if wireguard_dns | default([]) | length > 0 %}
# DNS servers
DNS = {{ wireguard_dns | join(', ') }}
{% endif %}

# PostUp: Commands to run after interface comes up
{% if wireguard_port_forwards | default([]) | length > 0 %}
# Enable IP forwarding and set up NAT/port forwarding
PostUp = sysctl -w net.ipv4.ip_forward=1
{% for forward in wireguard_port_forwards %}
PostUp = iptables -t nat -A PREROUTING -p {{ forward.protocol }} --dport {{ forward.external_port }} -j DNAT --to-destination {{ forward.internal_ip }}:{{ forward.internal_port }}
{% endfor %}
PostUp = iptables -t nat -A POSTROUTING -o %i -j MASQUERADE
{% endif %}
{% for cmd in wireguard_post_up | default([]) %}
PostUp = {{ cmd }}
{% endfor %}

# PostDown: Commands to run after interface goes down
{% if wireguard_port_forwards | default([]) | length > 0 %}
{% for forward in wireguard_port_forwards %}
PostDown = iptables -t nat -D PREROUTING -p {{ forward.protocol }} --dport {{ forward.external_port }} -j DNAT --to-destination {{ forward.internal_ip }}:{{ forward.internal_port }} || true
{% endfor %}
PostDown = iptables -t nat -D POSTROUTING -o %i -j MASQUERADE || true
{% endif %}
{% for cmd in wireguard_post_down | default([]) %}
PostDown = {{ cmd }}
{% endfor %}

{% for client in wireguard_clients | default([]) %}
# ============================================================
# Peer: {{ client.name }}
# ============================================================
[Peer]
# {{ client.name }} public key
PublicKey = {{ client.public_key }}

{% if client.preshared_key is defined and client.preshared_key | length > 0 %}
# Preshared key for additional security
PresharedKey = {{ client.preshared_key }}
{% endif %}

# Networks accessible through this peer
# Includes the peer's WireGuard IP and any internal networks it advertises
AllowedIPs = {{ client.allowed_ips }}

{% if client.persistent_keepalive is defined %}
# Keepalive for NAT traversal
PersistentKeepalive = {{ client.persistent_keepalive }}
{% endif %}

{% endfor %}
