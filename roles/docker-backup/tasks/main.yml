---
# Docker Backup Role - Main Tasks
# This role deploys backup/restore scripts from the homelab-backup repo,
# installs dependencies (restic, yq), creates backup.env with Infisical
# secrets, and sets up the homelab-backup systemd timer.

# ============================================================================
# Fetch per-app token (if enabled)
# ============================================================================

- name: Fetch per-app Infisical token for Backup
  ansible.builtin.shell: |
    infisical secrets get BACKUP_INFISICAL_TOKEN --path="/infrastructure/tokens" --plain --silent --projectId="{{ lookup('env', 'INFISICAL_PROJECT_ID') }}" --env={{ env | default('dev') }}
  register: backup_per_app_token_result
  delegate_to: localhost
  become: false
  changed_when: false
  no_log: true
  environment:
    INFISICAL_TOKEN: "{{ lookup('env', 'INFISICAL_TOKEN') }}"
    INFISICAL_PROJECT_ID: "{{ lookup('env', 'INFISICAL_PROJECT_ID') }}"
  when: backup_use_per_app_token | default(true)

- name: Set Infisical token to use for backup secrets
  ansible.builtin.set_fact:
    backup_infisical_token: "{{ backup_per_app_token_result.stdout if (backup_use_per_app_token | default(true) and backup_per_app_token_result is not skipped) else lookup('env', 'INFISICAL_TOKEN') }}"
  no_log: true

# ============================================================================
# Fetch secrets from Infisical
# ============================================================================

- name: Retrieve RESTIC_PASSWORD from Infisical
  ansible.builtin.shell: |
    infisical secrets get RESTIC_PASSWORD --path="{{ backup_infisical_path }}" --plain --silent --projectId="{{ lookup('env', 'INFISICAL_PROJECT_ID') }}" --env={{ env | default('dev') }}
  register: backup_restic_password_result
  delegate_to: localhost
  become: false
  changed_when: false
  no_log: true
  environment:
    INFISICAL_TOKEN: "{{ backup_infisical_token }}"
    INFISICAL_PROJECT_ID: "{{ lookup('env', 'INFISICAL_PROJECT_ID') }}"

- name: Set RESTIC_PASSWORD fact
  ansible.builtin.set_fact:
    backup_restic_password: "{{ backup_restic_password_result.stdout }}"
  no_log: true

- name: Retrieve B2_ACCOUNT_ID from Infisical
  ansible.builtin.shell: |
    infisical secrets get B2_ACCOUNT_ID --path="{{ backup_infisical_path }}" --plain --silent --projectId="{{ lookup('env', 'INFISICAL_PROJECT_ID') }}" --env={{ env | default('dev') }}
  register: backup_b2_account_id_result
  delegate_to: localhost
  become: false
  changed_when: false
  no_log: true
  environment:
    INFISICAL_TOKEN: "{{ backup_infisical_token }}"
    INFISICAL_PROJECT_ID: "{{ lookup('env', 'INFISICAL_PROJECT_ID') }}"

- name: Set B2_ACCOUNT_ID fact
  ansible.builtin.set_fact:
    backup_b2_account_id: "{{ backup_b2_account_id_result.stdout }}"
  no_log: true

- name: Retrieve B2_ACCOUNT_KEY from Infisical
  ansible.builtin.shell: |
    infisical secrets get B2_ACCOUNT_KEY --path="{{ backup_infisical_path }}" --plain --silent --projectId="{{ lookup('env', 'INFISICAL_PROJECT_ID') }}" --env={{ env | default('dev') }}
  register: backup_b2_account_key_result
  delegate_to: localhost
  become: false
  changed_when: false
  no_log: true
  environment:
    INFISICAL_TOKEN: "{{ backup_infisical_token }}"
    INFISICAL_PROJECT_ID: "{{ lookup('env', 'INFISICAL_PROJECT_ID') }}"

- name: Set B2_ACCOUNT_KEY fact
  ansible.builtin.set_fact:
    backup_b2_account_key: "{{ backup_b2_account_key_result.stdout }}"
  no_log: true

- name: Retrieve B2_BUCKET from Infisical
  ansible.builtin.shell: |
    infisical secrets get B2_BUCKET --path="{{ backup_infisical_path }}" --plain --silent --projectId="{{ lookup('env', 'INFISICAL_PROJECT_ID') }}" --env={{ env | default('dev') }}
  register: backup_b2_bucket_result
  delegate_to: localhost
  become: false
  changed_when: false
  no_log: true
  environment:
    INFISICAL_TOKEN: "{{ backup_infisical_token }}"
    INFISICAL_PROJECT_ID: "{{ lookup('env', 'INFISICAL_PROJECT_ID') }}"

- name: Set B2_BUCKET fact
  ansible.builtin.set_fact:
    backup_b2_bucket: "{{ backup_b2_bucket_result.stdout }}"
  no_log: true

- name: Retrieve DISCORD_WEBHOOK_URL from Infisical (optional)
  ansible.builtin.shell: |
    infisical secrets get DISCORD_WEBHOOK_URL --path="/infrastructure/backup" --plain --silent --projectId="{{ lookup('env', 'INFISICAL_PROJECT_ID') }}" --env={{ env | default('dev') }}
  register: backup_discord_webhook_result
  delegate_to: localhost
  become: false
  changed_when: false
  failed_when: false
  environment:
    INFISICAL_TOKEN: "{{ lookup('env', 'INFISICAL_TOKEN') }}"
    INFISICAL_PROJECT_ID: "{{ lookup('env', 'INFISICAL_PROJECT_ID') }}"

- name: Set DISCORD_WEBHOOK_URL fact
  ansible.builtin.set_fact:
    backup_discord_webhook: "{{ backup_discord_webhook_result.stdout | default('') }}"

# ============================================================================
# Atlas backup SSH keypair — fetch or auto-generate
# ============================================================================
# The backup system uses a dedicated SSH keypair for rsync to atlas.
# If keys don't exist in Infisical yet, we generate them automatically
# and store them so all hosts share the same keypair.

- name: Retrieve BACKUP_SSH_PRIVATE_KEY from Infisical
  ansible.builtin.shell: |
    infisical secrets get BACKUP_SSH_PRIVATE_KEY --path="{{ backup_infisical_path }}" --plain --silent --projectId="{{ lookup('env', 'INFISICAL_PROJECT_ID') }}" --env={{ env | default('dev') }}
  register: backup_ssh_key_result
  delegate_to: localhost
  become: false
  changed_when: false
  no_log: true
  failed_when: false
  environment:
    INFISICAL_TOKEN: "{{ backup_infisical_token }}"
    INFISICAL_PROJECT_ID: "{{ lookup('env', 'INFISICAL_PROJECT_ID') }}"
  when: backup_atlas_host | default('') | length > 0
  run_once: true

- name: Generate backup SSH keypair if not in Infisical
  when:
    - backup_atlas_host | default('') | length > 0
    - backup_ssh_key_result.stdout | default('') | length == 0
  run_once: true
  block:
    - name: Generate ed25519 SSH keypair for backup
      ansible.builtin.shell: |
        set -e
        TMPDIR=$(mktemp -d)
        ssh-keygen -t ed25519 -f "${TMPDIR}/atlas_backup" -N "" -C "homelab-backup-rsync" -q
        cat "${TMPDIR}/atlas_backup"
        echo "---PUBKEY_SEPARATOR---"
        cat "${TMPDIR}/atlas_backup.pub"
        rm -rf "${TMPDIR}"
      register: backup_keygen_result
      delegate_to: localhost
      become: false
      changed_when: true
      no_log: true

    - name: Parse generated keypair
      ansible.builtin.set_fact:
        _generated_private_key: "{{ backup_keygen_result.stdout.split('---PUBKEY_SEPARATOR---')[0] | trim }}"
        _generated_public_key: "{{ backup_keygen_result.stdout.split('---PUBKEY_SEPARATOR---')[1] | trim }}"
      no_log: true

    - name: Write keys to temp files for Infisical upload
      ansible.builtin.copy:
        content: "{{ item.content }}"
        dest: "{{ item.dest }}"
        mode: '0600'
      delegate_to: localhost
      become: false
      no_log: true
      loop:
        - { content: "{{ _generated_private_key }}", dest: "/tmp/.backup_ssh_privkey_tmp" }
        - { content: "{{ _generated_public_key }}", dest: "/tmp/.backup_ssh_pubkey_tmp" }

    - name: Store BACKUP_SSH_PRIVATE_KEY in Infisical via API
      ansible.builtin.shell: |
        set -eo pipefail
        SECRET_VALUE=$(jq -Rs . < /tmp/.backup_ssh_privkey_tmp)
        # Try to create (POST); if it already exists, update (PATCH)
        HTTP_CODE=$(curl -s -o /tmp/.infisical_resp -w '%{http_code}' \
          -X POST "{{ lookup('env', 'INFISICAL_API_URL') | default('https://app.infisical.com', true) }}/api/v3/secrets/raw/BACKUP_SSH_PRIVATE_KEY" \
          -H "Authorization: Bearer $INFISICAL_TOKEN" \
          -H "Content-Type: application/json" \
          -d "{\"workspaceId\": \"$INFISICAL_PROJECT_ID\", \"environment\": \"{{ env | default('dev') }}\", \"secretPath\": \"{{ backup_infisical_path }}\", \"secretValue\": ${SECRET_VALUE}, \"type\": \"shared\"}")
        if [ "$HTTP_CODE" = "400" ]; then
          HTTP_CODE=$(curl -s -o /tmp/.infisical_resp -w '%{http_code}' \
            -X PATCH "{{ lookup('env', 'INFISICAL_API_URL') | default('https://app.infisical.com', true) }}/api/v3/secrets/raw/BACKUP_SSH_PRIVATE_KEY" \
            -H "Authorization: Bearer $INFISICAL_TOKEN" \
            -H "Content-Type: application/json" \
            -d "{\"workspaceId\": \"$INFISICAL_PROJECT_ID\", \"environment\": \"{{ env | default('dev') }}\", \"secretPath\": \"{{ backup_infisical_path }}\", \"secretValue\": ${SECRET_VALUE}, \"type\": \"shared\"}")
        fi
        rm -f /tmp/.infisical_resp
        if [ "$HTTP_CODE" != "200" ]; then
          echo "Failed to store private key, HTTP $HTTP_CODE" >&2
          exit 1
        fi
      delegate_to: localhost
      become: false
      changed_when: true
      no_log: true
      environment:
        INFISICAL_TOKEN: "{{ lookup('env', 'INFISICAL_TOKEN') }}"
        INFISICAL_PROJECT_ID: "{{ lookup('env', 'INFISICAL_PROJECT_ID') }}"

    - name: Store BACKUP_SSH_PUBLIC_KEY in Infisical via API
      ansible.builtin.shell: |
        set -eo pipefail
        SECRET_VALUE=$(jq -Rs . < /tmp/.backup_ssh_pubkey_tmp)
        HTTP_CODE=$(curl -s -o /tmp/.infisical_resp -w '%{http_code}' \
          -X POST "{{ lookup('env', 'INFISICAL_API_URL') | default('https://app.infisical.com', true) }}/api/v3/secrets/raw/BACKUP_SSH_PUBLIC_KEY" \
          -H "Authorization: Bearer $INFISICAL_TOKEN" \
          -H "Content-Type: application/json" \
          -d "{\"workspaceId\": \"$INFISICAL_PROJECT_ID\", \"environment\": \"{{ env | default('dev') }}\", \"secretPath\": \"{{ backup_infisical_path }}\", \"secretValue\": ${SECRET_VALUE}, \"type\": \"shared\"}")
        if [ "$HTTP_CODE" = "400" ]; then
          HTTP_CODE=$(curl -s -o /tmp/.infisical_resp -w '%{http_code}' \
            -X PATCH "{{ lookup('env', 'INFISICAL_API_URL') | default('https://app.infisical.com', true) }}/api/v3/secrets/raw/BACKUP_SSH_PUBLIC_KEY" \
            -H "Authorization: Bearer $INFISICAL_TOKEN" \
            -H "Content-Type: application/json" \
            -d "{\"workspaceId\": \"$INFISICAL_PROJECT_ID\", \"environment\": \"{{ env | default('dev') }}\", \"secretPath\": \"{{ backup_infisical_path }}\", \"secretValue\": ${SECRET_VALUE}, \"type\": \"shared\"}")
        fi
        rm -f /tmp/.infisical_resp
        if [ "$HTTP_CODE" != "200" ]; then
          echo "Failed to store public key, HTTP $HTTP_CODE" >&2
          exit 1
        fi
      delegate_to: localhost
      become: false
      changed_when: true
      no_log: true
      environment:
        INFISICAL_TOKEN: "{{ lookup('env', 'INFISICAL_TOKEN') }}"
        INFISICAL_PROJECT_ID: "{{ lookup('env', 'INFISICAL_PROJECT_ID') }}"

    - name: Remove temp key files
      ansible.builtin.file:
        path: "{{ item }}"
        state: absent
      delegate_to: localhost
      become: false
      loop:
        - /tmp/.backup_ssh_privkey_tmp
        - /tmp/.backup_ssh_pubkey_tmp

    - name: Update SSH key result with generated key
      ansible.builtin.set_fact:
        backup_ssh_key_result:
          stdout: "{{ _generated_private_key }}"
      no_log: true

- name: Set BACKUP_SSH_PRIVATE_KEY fact
  ansible.builtin.set_fact:
    backup_ssh_private_key: "{{ backup_ssh_key_result.stdout | default('') }}"
  no_log: true
  when: backup_atlas_host | default('') | length > 0

# ============================================================================
# Install dependencies
# ============================================================================

- name: Install backup dependencies
  ansible.builtin.apt:
    name:
      - curl
      - jq
      - bzip2
      - rsync
    state: present
    update_cache: yes
  become: true

- name: Install restic
  ansible.builtin.shell: |
    set -e
    if ! command -v restic &> /dev/null; then
      curl -fL --retry 3 --retry-delay 5 https://github.com/restic/restic/releases/download/v0.16.4/restic_0.16.4_linux_amd64.bz2 -o /tmp/restic.bz2
      bunzip2 -f /tmp/restic.bz2
      mv /tmp/restic /usr/local/bin/restic
      chmod +x /usr/local/bin/restic
      echo "changed"
    else
      echo "ok"
    fi
  register: restic_install
  changed_when: restic_install.stdout == "changed"
  retries: 3
  delay: 10
  until: restic_install.rc == 0
  become: true

- name: Install yq for config-driven backups
  ansible.builtin.shell: |
    set -e
    if ! command -v yq &> /dev/null; then
      curl -fL --retry 3 --retry-delay 5 https://github.com/mikefarah/yq/releases/download/v4.44.1/yq_linux_amd64 -o /usr/local/bin/yq
      chmod +x /usr/local/bin/yq
      echo "changed"
    else
      echo "ok"
    fi
  register: yq_install
  changed_when: yq_install.stdout == "changed"
  retries: 3
  delay: 10
  until: yq_install.rc == 0
  become: true

- name: Verify restic installation
  ansible.builtin.command: restic version
  register: restic_version
  changed_when: false

- name: Display restic version
  ansible.builtin.debug:
    msg: "Restic installed: {{ restic_version.stdout }}"

# ============================================================================
# Deploy Atlas backup SSH key (for rsync to atlas)
# ============================================================================

- name: Create SSH directory for Atlas backup key
  ansible.builtin.file:
    path: "{{ backup_atlas_ssh_key_path | dirname }}"
    state: directory
    owner: root
    group: root
    mode: '0700'
  become: true
  when:
    - backup_atlas_host | default('') | length > 0
    - backup_ssh_private_key | default('') | length > 0

- name: Deploy Atlas backup SSH private key
  ansible.builtin.copy:
    content: "{{ backup_ssh_private_key }}\n"
    dest: "{{ backup_atlas_ssh_key_path }}"
    owner: root
    group: root
    mode: '0600'
  become: true
  no_log: true
  when:
    - backup_atlas_host | default('') | length > 0
    - backup_ssh_private_key | default('') | length > 0

# ============================================================================
# Deploy backup/restore scripts from homelab-backup repo
# ============================================================================

- name: Verify homelab-backup repo exists on controller
  ansible.builtin.stat:
    path: "{{ backup_repo_path }}/scripts/backup.sh"
  delegate_to: localhost
  become: false
  register: backup_repo_check

- name: Fail if homelab-backup repo not found
  ansible.builtin.fail:
    msg: >
      homelab-backup repo not found at {{ backup_repo_path }}.
      Run 'ansible-playbook playbooks/bootstrap.yml' first to clone it.
  when: not backup_repo_check.stat.exists

- name: Create scripts directory
  ansible.builtin.file:
    path: "{{ backup_scripts_dest }}"
    state: directory
    owner: root
    group: root
    mode: '0755'
  become: true

- name: Deploy backup.sh
  ansible.builtin.copy:
    src: "{{ backup_repo_path }}/scripts/backup.sh"
    dest: "{{ backup_scripts_dest }}/backup.sh"
    owner: root
    group: root
    mode: '0755'
  become: true

- name: Deploy restore.sh
  ansible.builtin.copy:
    src: "{{ backup_repo_path }}/scripts/restore.sh"
    dest: "{{ backup_scripts_dest }}/restore.sh"
    owner: root
    group: root
    mode: '0755'
  become: true

# ============================================================================
# Deploy backup.env with Infisical secrets
# ============================================================================

- name: Deploy backup.env
  ansible.builtin.copy:
    content: |
      # Atlas Backup Server (primary backup target)
      ATLAS_HOST={{ backup_atlas_host }}
      ATLAS_USER={{ backup_atlas_user }}
      ATLAS_SSH_KEY={{ backup_atlas_ssh_key_path }}
      ATLAS_BACKUP_DIR={{ backup_atlas_backup_dir }}

      # Backblaze B2 Configuration (restore fallback)
      B2_ACCOUNT_ID={{ backup_b2_account_id }}
      B2_ACCOUNT_KEY={{ backup_b2_account_key }}
      B2_BUCKET={{ backup_b2_bucket }}

      # Restic encryption password (for B2 restore fallback)
      RESTIC_PASSWORD={{ backup_restic_password }}

      # Discord Notifications
      DISCORD_WEBHOOK_URL={{ backup_discord_webhook | default('') }}

      # Host identification
      HOSTNAME_PREFIX={{ inventory_hostname }}
    dest: "{{ backup_scripts_dest }}/backup.env"
    owner: root
    group: root
    mode: '0600'
  no_log: true
  become: true

# ============================================================================
# Deploy systemd timer for automated backups
# ============================================================================

- name: Deploy homelab-backup systemd service
  ansible.builtin.copy:
    src: "{{ backup_repo_path }}/systemd/homelab-backup.service"
    dest: /etc/systemd/system/homelab-backup.service
    owner: root
    group: root
    mode: '0644'
  become: true
  notify: Reload systemd

- name: Deploy homelab-backup systemd timer
  ansible.builtin.copy:
    src: "{{ backup_repo_path }}/systemd/homelab-backup.timer"
    dest: /etc/systemd/system/homelab-backup.timer
    owner: root
    group: root
    mode: '0644'
  become: true
  notify: Reload systemd

- name: Enable and start backup timer
  ansible.builtin.systemd:
    name: homelab-backup.timer
    enabled: yes
    state: started
    daemon_reload: yes
  become: true
  when: backup_enabled | bool

# ============================================================================
# Display summary
# ============================================================================

- name: Display backup configuration
  ansible.builtin.debug:
    msg:
      - "✅ Docker backup role configured successfully!"
      - ""
      - "Scripts deployed to {{ backup_scripts_dest }}:"
      - "  - {{ backup_scripts_dest }}/backup.sh"
      - "  - {{ backup_scripts_dest }}/restore.sh"
      - "  - {{ backup_scripts_dest }}/backup.env"
      - ""
      - "Systemd timer: homelab-backup.timer (daily at 3 AM)"
      - ""
      - "Manual commands:"
      - "  - Check timer: systemctl status homelab-backup.timer"
      - "  - Run backup:  sudo {{ backup_scripts_dest }}/backup.sh all full"
      - "  - Restore:     sudo {{ backup_scripts_dest }}/restore.sh <stack> latest"

# ============================================================================
# Include restore tasks if enabled (for pre-deployment restore)
# ============================================================================

- name: Include pre-deployment restore tasks
  ansible.builtin.include_tasks: restore.yml
  when: restore_enabled | default(false) | bool
