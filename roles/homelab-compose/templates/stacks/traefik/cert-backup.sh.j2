#!/bin/bash
# Traefik Certificate Backup Script for Docker Host
# Backs up acme.json to Backblaze B2 using restic
#
# Usage: cert-backup.sh [backup|restore|list]
#
# Environment: Loaded from /opt/stacks/traefik/backup.env

set -euo pipefail

ACTION="${1:-backup}"
BACKUP_DIR="{{ stacks_base_dir }}/traefik"
ACME_FILE="${BACKUP_DIR}/config/acme.json"
ENV_FILE="${BACKUP_DIR}/backup.env"
HOSTNAME_PREFIX="${HOSTNAME:-{{ inventory_hostname }}}"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

log_info() { echo -e "${GREEN}[INFO]${NC} $(date '+%Y-%m-%d %H:%M:%S') - $1"; }
log_warn() { echo -e "${YELLOW}[WARN]${NC} $(date '+%Y-%m-%d %H:%M:%S') - $1"; }
log_error() { echo -e "${RED}[ERROR]${NC} $(date '+%Y-%m-%d %H:%M:%S') - $1"; }

# Check if certificates in acme.json are still valid
# Returns 0 if at least one certificate is valid, 1 if all expired
check_cert_validity() {
    local acme_file="$1"
    local min_days_valid="${2:-7}"  # Default: cert must be valid for at least 7 more days
    local now_epoch=$(date +%s)
    local min_valid_epoch=$((now_epoch + min_days_valid * 86400))
    local valid_count=0
    local expired_count=0
    
    # Extract and check each certificate
    while IFS= read -r cert_b64; do
        if [[ -n "${cert_b64}" ]]; then
            # Decode and get expiry date
            local expiry_date=$(echo "${cert_b64}" | base64 -d 2>/dev/null | \
                openssl x509 -noout -enddate 2>/dev/null | \
                sed 's/notAfter=//')
            
            if [[ -n "${expiry_date}" ]]; then
                local expiry_epoch=$(date -d "${expiry_date}" +%s 2>/dev/null || echo "0")
                local domain=$(echo "${cert_b64}" | base64 -d 2>/dev/null | \
                    openssl x509 -noout -subject 2>/dev/null | \
                    sed 's/.*CN *= *//' | sed 's/,.*//')
                
                if [[ "${expiry_epoch}" -gt "${min_valid_epoch}" ]]; then
                    log_info "  ✓ ${domain}: valid until ${expiry_date}"
                    ((valid_count++))
                else
                    log_warn "  ✗ ${domain}: expires ${expiry_date} (less than ${min_days_valid} days remaining)"
                    ((expired_count++))
                fi
            fi
        fi
    done < <(cat "${acme_file}" | jq -r '.mytls.Certificates[]?.certificate' 2>/dev/null)
    
    log_info "Certificate check: ${valid_count} valid, ${expired_count} expired/expiring soon"
    
    [[ "${valid_count}" -gt 0 ]]
}

# Load environment
if [[ -f "${ENV_FILE}" ]]; then
    source "${ENV_FILE}"
else
    log_error "Environment file not found: ${ENV_FILE}"
    exit 1
fi

# Validate required variables
if [[ -z "${B2_ACCOUNT_ID:-}" ]] || [[ -z "${B2_ACCOUNT_KEY:-}" ]] || [[ -z "${RESTIC_PASSWORD:-}" ]]; then
    log_error "Missing required environment variables: B2_ACCOUNT_ID, B2_ACCOUNT_KEY, RESTIC_PASSWORD"
    exit 1
fi

# Set up restic repository
export B2_ACCOUNT_ID
export B2_ACCOUNT_KEY
export RESTIC_PASSWORD
RESTIC_REPO="b2:${B2_BUCKET:-homelab-backups}:${HOSTNAME_PREFIX}/traefik-certs"

init_repo() {
    log_info "Initializing restic repository: ${RESTIC_REPO}"
    if ! restic -r "${RESTIC_REPO}" snapshots &>/dev/null; then
        restic -r "${RESTIC_REPO}" init || true
    fi
}

do_backup() {
    if [[ ! -f "${ACME_FILE}" ]]; then
        log_warn "No acme.json found at ${ACME_FILE}, nothing to backup"
        exit 0
    fi
    
    # Check if acme.json has any certificates
    CERT_COUNT=$(cat "${ACME_FILE}" | jq '.mytls.Certificates | length' 2>/dev/null || echo "0")
    if [[ "${CERT_COUNT}" == "0" ]] || [[ "${CERT_COUNT}" == "null" ]]; then
        log_warn "acme.json has no certificates, skipping backup"
        exit 0
    fi
    
    init_repo
    
    log_info "Backing up ${CERT_COUNT} certificates from ${ACME_FILE}"
    
    # Create a temp directory with proper structure
    TEMP_DIR=$(mktemp -d)
    cp "${ACME_FILE}" "${TEMP_DIR}/acme.json"
    
    # Backup with restic
    restic -r "${RESTIC_REPO}" backup "${TEMP_DIR}" \
        --tag "traefik-certs" \
        --tag "{{ hostvars[inventory_hostname].env | default('dev') }}" \
        --verbose
    
    rm -rf "${TEMP_DIR}"
    
    # Prune old snapshots (keep last 10)
    restic -r "${RESTIC_REPO}" forget \
        --keep-last 10 \
        --prune
    
    log_info "Backup complete!"
}

do_restore() {
    init_repo
    
    log_info "Checking for certificate backups..."
    
    # Check if any snapshots exist
    if ! restic -r "${RESTIC_REPO}" snapshots --json | jq -e '.[0]' &>/dev/null; then
        log_warn "No certificate backups found in ${RESTIC_REPO}"
        exit 0
    fi
    
    # Get latest snapshot
    LATEST=$(restic -r "${RESTIC_REPO}" snapshots --json --latest 1 | jq -r '.[0].id')
    log_info "Restoring from snapshot: ${LATEST}"
    
    # Create temp restore directory
    RESTORE_DIR=$(mktemp -d)
    
    # Restore
    restic -r "${RESTIC_REPO}" restore "${LATEST}" --target "${RESTORE_DIR}"
    
    # Find the acme.json in restored data
    RESTORED_ACME=$(find "${RESTORE_DIR}" -name "acme.json" -type f | head -1)
    
    if [[ -n "${RESTORED_ACME}" ]] && [[ -f "${RESTORED_ACME}" ]]; then
        # Validate restored file
        CERT_COUNT=$(cat "${RESTORED_ACME}" | jq '.mytls.Certificates | length' 2>/dev/null || echo "0")
        log_info "Found ${CERT_COUNT} certificates in backup"
        
        if [[ "${CERT_COUNT}" != "0" ]] && [[ "${CERT_COUNT}" != "null" ]]; then
            # Check if certificates are still valid (not expired)
            log_info "Checking certificate validity..."
            if check_cert_validity "${RESTORED_ACME}" 7; then
                # Backup existing file if present
                if [[ -f "${ACME_FILE}" ]] && [[ -s "${ACME_FILE}" ]]; then
                    cp "${ACME_FILE}" "${ACME_FILE}.bak.$(date +%Y%m%d_%H%M%S)"
                fi
                
                # Restore with proper permissions (nobody user for traefik)
                cp "${RESTORED_ACME}" "${ACME_FILE}"
                chmod 600 "${ACME_FILE}"
                chown 65534:docker "${ACME_FILE}"
                
                log_info "Certificates restored successfully to ${ACME_FILE}"
                
                # List restored certificates
                log_info "Restored certificates:"
                cat "${ACME_FILE}" | jq -r '.mytls.Certificates[]?.domain.main' 2>/dev/null || true
            else
                log_warn "All certificates in backup are expired or expiring soon"
                log_warn "Skipping restore - Traefik will request new certificates from Let's Encrypt"
            fi
        else
            log_warn "Restored backup has no certificates, keeping existing file"
        fi
    else
        log_warn "No acme.json found in backup"
    fi
    
    rm -rf "${RESTORE_DIR}"
}

do_list() {
    init_repo
    log_info "Available certificate backups:"
    restic -r "${RESTIC_REPO}" snapshots
}

case "${ACTION}" in
    backup)
        do_backup
        ;;
    restore)
        do_restore
        ;;
    list)
        do_list
        ;;
    *)
        echo "Usage: $0 [backup|restore|list]"
        exit 1
        ;;
esac
