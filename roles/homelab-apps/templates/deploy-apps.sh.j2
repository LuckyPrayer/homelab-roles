#!/bin/bash
# Deploy all homelab-apps for this host
# Auto-generated by Ansible homelab-apps role
#
# Usage:
#   ./deploy-apps.sh              # Deploy all apps
#   ./deploy-apps.sh <app_name>   # Deploy single app
#   ./deploy-apps.sh --pull       # Pull updates and deploy

set -euo pipefail

HOMELAB_APPS_PATH="{{ homelab_stacks_path | default('/opt/stacks') }}"
HOST="{{ inventory_hostname }}"
ENV="{{ host_config.env | default('dev') }}"
BASE_DOMAIN="{{ manifest.settings.defaults.BASE_DOMAIN | default('thebozic.com') }}"
TZ="{{ manifest.settings.defaults.TZ | default('America/Toronto') }}"

# Apps for this host (from manifest)
APPS=({% for app in deployable_apps %}"{{ app }}" {% endfor %})

# Colors
GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

log_info() { echo -e "${BLUE}[INFO]${NC} $*"; }
log_success() { echo -e "${GREEN}[OK]${NC} $*"; }
log_warn() { echo -e "${YELLOW}[WARN]${NC} $*"; }
log_error() { echo -e "${RED}[ERROR]${NC} $*"; }

deploy_app() {
    local app_name="$1"
    local app_path="${HOMELAB_APPS_PATH}/${app_name}"
    
    if [[ ! -d "$app_path" ]]; then
        log_warn "App directory not found: $app_path"
        return 1
    fi
    
    if [[ ! -f "${app_path}/docker-compose.yml" ]]; then
        log_warn "No docker-compose.yml found for $app_name"
        return 1
    fi
    
    log_info "Deploying $app_name..."
    
    cd "$app_path"
    
    # Check if app has secrets (config.yml with infisical_path)
    if [[ -f config.yml ]]; then
        INFISICAL_PATH=$(grep -A2 "^secrets:" config.yml | grep "infisical_path:" | awk '{print $2}' | tr -d '"' || echo "")
        
        if [[ -n "$INFISICAL_PATH" && "$INFISICAL_PATH" != "null" ]]; then
            log_info "Using Infisical secrets from $INFISICAL_PATH"
            ENV="$ENV" BASE_DOMAIN="$BASE_DOMAIN" TZ="$TZ" \
                infisical run --path="$INFISICAL_PATH" --env="$ENV" -- \
                docker compose up -d --remove-orphans
        else
            ENV="$ENV" BASE_DOMAIN="$BASE_DOMAIN" TZ="$TZ" \
                docker compose up -d --remove-orphans
        fi
    else
        ENV="$ENV" BASE_DOMAIN="$BASE_DOMAIN" TZ="$TZ" \
            docker compose up -d --remove-orphans
    fi
    
    log_success "$app_name deployed"
}

pull_updates() {
    log_info "Pulling latest from git..."
    cd "$HOMELAB_APPS_PATH"
    git pull --ff-only
    log_success "Repository updated"
}

# Parse arguments
PULL_FIRST=false
SINGLE_APP=""

while [[ $# -gt 0 ]]; do
    case "$1" in
        --pull|-p)
            PULL_FIRST=true
            shift
            ;;
        --help|-h)
            echo "Usage: $0 [--pull] [app_name]"
            echo ""
            echo "Options:"
            echo "  --pull, -p    Pull git updates before deploying"
            echo "  app_name      Deploy only the specified app"
            echo ""
            echo "Available apps: ${APPS[*]}"
            exit 0
            ;;
        *)
            SINGLE_APP="$1"
            shift
            ;;
    esac
done

echo ""
echo "════════════════════════════════════════════════════════════════"
echo "  Homelab Apps Deployment - ${HOST}"
echo "════════════════════════════════════════════════════════════════"
echo ""

# Pull if requested
if [[ "$PULL_FIRST" == "true" ]]; then
    pull_updates
fi

# Deploy
if [[ -n "$SINGLE_APP" ]]; then
    # Single app deployment
    if [[ " ${APPS[*]} " =~ " ${SINGLE_APP} " ]]; then
        deploy_app "$SINGLE_APP"
    else
        log_error "App '$SINGLE_APP' is not configured for this host"
        log_info "Available apps: ${APPS[*]}"
        exit 1
    fi
else
    # Deploy all apps
    FAILED=()
    for app in "${APPS[@]}"; do
        if ! deploy_app "$app"; then
            FAILED+=("$app")
        fi
    done
    
    echo ""
    echo "════════════════════════════════════════════════════════════════"
    if [[ ${{ '{#' }}FAILED[@]} -eq 0 ]]; then
        log_success "All apps deployed successfully"
    else
        log_warn "Some apps failed to deploy: ${FAILED[*]}"
    fi
    echo "════════════════════════════════════════════════════════════════"
fi
