#!/bin/bash
# Check status of all homelab-apps containers
# Auto-generated by Ansible homelab-apps role
#
# Usage:
#   ./app-status.sh           # Show all apps
#   ./app-status.sh --json    # JSON output

set -euo pipefail

HOST="{{ inventory_hostname }}"
ENV="{{ host_config.env | default('dev') }}"

# Apps for this host (from manifest)
APPS=({% for app in deployable_apps %}"{{ app }}" {% endfor %})

# Colors
GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

JSON_OUTPUT=false
if [[ "${1:-}" == "--json" ]]; then
    JSON_OUTPUT=true
fi

if [[ "$JSON_OUTPUT" == "true" ]]; then
    echo "{"
    echo "  \"host\": \"$HOST\","
    echo "  \"env\": \"$ENV\","
    echo "  \"timestamp\": \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\","
    echo "  \"apps\": ["
    
    FIRST=true
    for app in "${APPS[@]}"; do
        STATUS=$(docker inspect --format='{{ "{{" }}.State.Status{{ "}}" }}' "$app" 2>/dev/null || echo "not-found")
        HEALTH=$(docker inspect --format='{{ "{{" }}if .State.Health{{ "}}" }}{{ "{{" }}.State.Health.Status{{ "}}" }}{{ "{{" }}else{{ "}}" }}N/A{{ "{{" }}end{{ "}}" }}' "$app" 2>/dev/null || echo "N/A")
        UPTIME=$(docker inspect --format='{{ "{{" }}.State.StartedAt{{ "}}" }}' "$app" 2>/dev/null || echo "")
        
        if [[ "$FIRST" == "true" ]]; then
            FIRST=false
        else
            echo ","
        fi
        
        echo -n "    {\"name\": \"$app\", \"status\": \"$STATUS\", \"health\": \"$HEALTH\", \"started\": \"$UPTIME\"}"
    done
    
    echo ""
    echo "  ]"
    echo "}"
else
    echo ""
    echo "════════════════════════════════════════════════════════════════"
    echo -e "  ${CYAN}Homelab Apps Status${NC} - ${HOST} (${ENV})"
    echo "════════════════════════════════════════════════════════════════"
    echo ""
    printf "%-20s %-12s %-10s %s\n" "APP" "STATUS" "HEALTH" "UPTIME"
    printf "%-20s %-12s %-10s %s\n" "---" "------" "------" "------"
    
    for app in "${APPS[@]}"; do
        STATUS=$(docker inspect --format='{{ "{{" }}.State.Status{{ "}}" }}' "$app" 2>/dev/null || echo "not-found")
        HEALTH=$(docker inspect --format='{{ "{{" }}if .State.Health{{ "}}" }}{{ "{{" }}.State.Health.Status{{ "}}" }}{{ "{{" }}else{{ "}}" }}N/A{{ "{{" }}end{{ "}}" }}' "$app" 2>/dev/null || echo "N/A")
        
        # Calculate uptime
        if [[ "$STATUS" == "running" ]]; then
            STARTED=$(docker inspect --format='{{ "{{" }}.State.StartedAt{{ "}}" }}' "$app" 2>/dev/null)
            if [[ -n "$STARTED" ]]; then
                STARTED_EPOCH=$(date -d "$STARTED" +%s 2>/dev/null || echo "0")
                NOW_EPOCH=$(date +%s)
                UPTIME_SECS=$((NOW_EPOCH - STARTED_EPOCH))
                
                if [[ $UPTIME_SECS -lt 60 ]]; then
                    UPTIME="${UPTIME_SECS}s"
                elif [[ $UPTIME_SECS -lt 3600 ]]; then
                    UPTIME="$((UPTIME_SECS / 60))m"
                elif [[ $UPTIME_SECS -lt 86400 ]]; then
                    UPTIME="$((UPTIME_SECS / 3600))h"
                else
                    UPTIME="$((UPTIME_SECS / 86400))d"
                fi
            else
                UPTIME="-"
            fi
        else
            UPTIME="-"
        fi
        
        # Color coding
        case "$STATUS" in
            running)
                STATUS_COLOR="${GREEN}running${NC}"
                ;;
            exited|dead)
                STATUS_COLOR="${RED}${STATUS}${NC}"
                ;;
            *)
                STATUS_COLOR="${YELLOW}${STATUS}${NC}"
                ;;
        esac
        
        case "$HEALTH" in
            healthy)
                HEALTH_COLOR="${GREEN}healthy${NC}"
                ;;
            unhealthy)
                HEALTH_COLOR="${RED}unhealthy${NC}"
                ;;
            *)
                HEALTH_COLOR="${YELLOW}${HEALTH}${NC}"
                ;;
        esac
        
        printf "%-20s %-21b %-19b %s\n" "$app" "$STATUS_COLOR" "$HEALTH_COLOR" "$UPTIME"
    done
    
    echo ""
    echo "════════════════════════════════════════════════════════════════"
    
    # Summary
    RUNNING=$(docker ps --filter "status=running" --format '{{ "{{" }}.Names{{ "}}" }}' | grep -c -E "^($(IFS='|'; echo "${APPS[*]}"))\$" || echo 0)
    TOTAL=${{ '{#' }}APPS[@]}
    
    if [[ "$RUNNING" -eq "$TOTAL" ]]; then
        echo -e "  ${GREEN}✓ All $TOTAL apps running${NC}"
    else
        echo -e "  ${YELLOW}⚠ $RUNNING/$TOTAL apps running${NC}"
    fi
    
    echo "════════════════════════════════════════════════════════════════"
    echo ""
fi
