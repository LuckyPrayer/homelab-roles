#!/usr/bin/env bash
# =============================================================================
# Homelab Apps - Secret Refresh Script
# =============================================================================
# Refreshes secrets from Infisical for all apps with .infisical-config
# and restarts containers if secrets have changed.
#
# Usage: /usr/local/bin/refresh-secrets.sh [--force] [app-name]
#   --force    Restart containers even if secrets haven't changed
#   app-name   Only refresh secrets for specific app (optional)
#
# Auto-generated by homelab-apps Ansible role
# =============================================================================

set -euo pipefail

HOMELAB_APPS_PATH="{{ homelab_apps_path }}"
INFISICAL_TOKEN_FILE="/root/.infisical-token"
INFISICAL_CONFIG="/etc/infisical/config.env"
LOG_TAG="refresh-secrets"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

log_info() {
    echo -e "${GREEN}[INFO]${NC} $1"
    logger -t "$LOG_TAG" "INFO: $1"
}

log_warn() {
    echo -e "${YELLOW}[WARN]${NC} $1"
    logger -t "$LOG_TAG" "WARN: $1"
}

log_error() {
    echo -e "${RED}[ERROR]${NC} $1"
    logger -t "$LOG_TAG" "ERROR: $1"
}

# Parse arguments
FORCE_RESTART=false
TARGET_APP=""

while [[ $# -gt 0 ]]; do
    case $1 in
        --force)
            FORCE_RESTART=true
            shift
            ;;
        *)
            TARGET_APP="$1"
            shift
            ;;
    esac
done

# Load Infisical config
if [[ -f "$INFISICAL_CONFIG" ]]; then
    set -a
    source "$INFISICAL_CONFIG"
    set +a
fi

# Get token from file if not in environment
if [[ -z "${INFISICAL_TOKEN:-}" && -f "$INFISICAL_TOKEN_FILE" ]]; then
    INFISICAL_TOKEN=$(cat "$INFISICAL_TOKEN_FILE")
    export INFISICAL_TOKEN
fi

if [[ -z "${INFISICAL_TOKEN:-}" ]]; then
    log_error "No Infisical token found. Cannot refresh secrets."
    exit 1
fi

if [[ -z "${INFISICAL_PROJECT_ID:-}" ]]; then
    log_error "No Infisical project ID configured."
    exit 1
fi

# Find all apps with Infisical config
refresh_app_secrets() {
    local app_dir="$1"
    local app_name=$(basename "$app_dir")
    local config_file="$app_dir/.infisical-config"
    
    if [[ ! -f "$config_file" ]]; then
        return 0
    fi
    
    # Load app-specific Infisical config
    source "$config_file"
    
    log_info "Refreshing secrets for $app_name (path: $INFISICAL_PATH)"
    
    # Create temporary file for new secrets
    local temp_secrets=$(mktemp)
    trap "rm -f $temp_secrets" RETURN
    
    # Export secrets from Infisical
    if ! infisical export \
        --path="$INFISICAL_PATH" \
        --env="$INFISICAL_ENV" \
        --format=dotenv \
        --projectId="$INFISICAL_PROJECT_ID" \
        --token="$INFISICAL_TOKEN" \
        > "$temp_secrets" 2>/dev/null; then
        log_error "Failed to export secrets for $app_name"
        return 1
    fi
    
    # Check if secrets have changed
    local secrets_changed=false
    if [[ -f "$app_dir/.env.secrets" ]]; then
        if ! diff -q "$app_dir/.env.secrets" "$temp_secrets" > /dev/null 2>&1; then
            secrets_changed=true
            log_info "Secrets changed for $app_name"
        fi
    else
        secrets_changed=true
        log_info "New secrets file for $app_name"
    fi
    
    if [[ "$secrets_changed" == "true" ]] || [[ "$FORCE_RESTART" == "true" ]]; then
        # Update secrets file
        cp "$temp_secrets" "$app_dir/.env.secrets"
        chmod 600 "$app_dir/.env.secrets"
        
        # Rebuild .env file
        if [[ -f "$app_dir/.env.base" ]]; then
            cat "$app_dir/.env.base" > "$app_dir/.env"
            echo "" >> "$app_dir/.env"
            echo "# Secrets from Infisical ($INFISICAL_PATH)" >> "$app_dir/.env"
            cat "$app_dir/.env.secrets" >> "$app_dir/.env"
            chmod 600 "$app_dir/.env"
        fi
        
        # Restart container with force-recreate to pick up new .env
        log_info "Restarting $app_name container..."
        cd "$app_dir"
        if docker compose up -d --force-recreate 2>/dev/null; then
            log_info "Successfully restarted $app_name"
        else
            log_error "Failed to restart $app_name"
            return 1
        fi
    else
        log_info "No changes for $app_name, skipping restart"
    fi
}

# Main execution
log_info "Starting secret refresh..."

if [[ -n "$TARGET_APP" ]]; then
    # Refresh specific app
    if [[ -d "$HOMELAB_APPS_PATH/$TARGET_APP" ]]; then
        refresh_app_secrets "$HOMELAB_APPS_PATH/$TARGET_APP"
    else
        log_error "App not found: $TARGET_APP"
        exit 1
    fi
else
    # Refresh all apps with Infisical config
    for app_dir in "$HOMELAB_APPS_PATH"/*/; do
        if [[ -f "$app_dir/.infisical-config" ]]; then
            refresh_app_secrets "$app_dir" || true
        fi
    done
fi

log_info "Secret refresh complete"
