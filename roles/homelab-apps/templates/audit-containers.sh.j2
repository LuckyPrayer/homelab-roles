#!/bin/bash
# Audit running containers against the manifest-defined app list
# Auto-generated by Ansible homelab-apps role
#
# Detects:
#   - Rogue containers: running but not in the manifest for this host
#   - Missing containers: expected but not running
#
# Usage:
#   audit-containers.sh              # Human-readable output
#   audit-containers.sh --json       # JSON output (for monitoring)
#   audit-containers.sh --remove     # Stop & remove rogue containers
#   audit-containers.sh --quiet      # Only output if issues found

set -euo pipefail

# =============================================================================
# Configuration (baked at deploy time by Ansible)
# =============================================================================
HOST="{{ inventory_hostname }}"
ENV="{{ host_config.env | default('dev') }}"
HOMELAB_APPS_PATH="{{ homelab_apps_path }}"

# Apps assigned to this host via manifest.yml
MANIFEST_APPS=({% for app in deployable_apps %}"{{ app }}" {% endfor %})

# Infrastructure containers deployed by Ansible roles (not in the manifest)
INFRA_CONTAINERS=(
{% if traefik_enabled | default(false) %}
    "traefik"
{% endif %}
{% if docker_socket_proxy_enabled | default(false) %}
    "docker-socket-proxy"
{% endif %}
{% if komodo_mode | default('') == 'periphery' %}
    "komodo-periphery"
{% endif %}
{% if komodo_mode | default('') == 'core' %}
    "komodo-core"
    "komodo-periphery"
    "komodo-mongo"
{% endif %}
{% if harbor_enabled | default(false) %}
    "harbor-core"
    "harbor-db"
    "harbor-jobservice"
    "harbor-log"
    "harbor-portal"
    "harbor-redis"
    "harbor-registry"
    "harbor-registryctl"
    "nginx"
{% endif %}
{% if pihole_web_port is defined %}
    "pihole"
{% endif %}
{% if router_enable_glances | default(false) %}
    "glances"
{% endif %}
{% if uptime_kuma_enabled | default(false) %}
    "uptime-kuma"
{% endif %}
    "node-exporter"
)

# Discord webhook for alerts (empty = disabled)
DISCORD_WEBHOOK_URL="{{ discord_bot_webhook_url | default('') }}"
DISCORD_WEBHOOK_PATH="/webhook/container-audit"

# =============================================================================
# Argument parsing
# =============================================================================
OUTPUT_JSON=false
REMOVE_ROGUE=false
QUIET=false

while [[ $# -gt 0 ]]; do
    case "$1" in
        --json|-j)     OUTPUT_JSON=true; shift ;;
        --remove|-r)   REMOVE_ROGUE=true; shift ;;
        --quiet|-q)    QUIET=true; shift ;;
        --help|-h)
            echo "Usage: $0 [--json] [--remove] [--quiet]"
            echo ""
            echo "Options:"
            echo "  --json, -j     Output results as JSON"
            echo "  --remove, -r   Stop and remove rogue containers"
            echo "  --quiet, -q    Only produce output when issues are found"
            echo ""
            echo "Manifest apps: ${MANIFEST_APPS[*]}"
            echo "Infra containers: ${INFRA_CONTAINERS[*]}"
            exit 0
            ;;
        *) echo "Unknown option: $1"; exit 1 ;;
    esac
done

# =============================================================================
# Colors (disabled for JSON/quiet modes)
# =============================================================================
if [[ "$OUTPUT_JSON" == "false" ]]; then
    GREEN='\033[0;32m'
    RED='\033[0;31m'
    YELLOW='\033[1;33m'
    BLUE='\033[0;34m'
    BOLD='\033[1m'
    NC='\033[0m'
else
    GREEN=''; RED=''; YELLOW=''; BLUE=''; BOLD=''; NC=''
fi

# =============================================================================
# Build the full "expected" container list
# =============================================================================
declare -A EXPECTED_MAP

for app in "${MANIFEST_APPS[@]}"; do
    [[ -n "$app" ]] && EXPECTED_MAP["$app"]=manifest
done

for ctr in "${INFRA_CONTAINERS[@]}"; do
    [[ -n "$ctr" ]] && EXPECTED_MAP["$ctr"]=infrastructure
done

# =============================================================================
# Get running containers
# =============================================================================
mapfile -t RUNNING < <(docker ps --format '{{ '{{' }}.Names{{ '}}' }}' 2>/dev/null | sort)

if [[ ${#RUNNING[@]} -eq 0 ]]; then
    if [[ "$OUTPUT_JSON" == "true" ]]; then
        echo '{"host":"'"$HOST"'","error":"no running containers or docker unavailable"}'
    else
        echo -e "${RED}ERROR: No running containers found (is Docker running?)${NC}"
    fi
    exit 1
fi

# =============================================================================
# Classify containers
# =============================================================================
ROGUE=()
MISSING=()
OK=()

# Find rogue containers (running but not expected)
for ctr in "${RUNNING[@]}"; do
    if [[ -v EXPECTED_MAP["$ctr"] ]]; then
        OK+=("$ctr")
    else
        ROGUE+=("$ctr")
    fi
done

# Find missing containers (expected but not running)
for expected in "${!EXPECTED_MAP[@]}"; do
    found=false
    for ctr in "${RUNNING[@]}"; do
        if [[ "$ctr" == "$expected" ]]; then
            found=true
            break
        fi
    done
    if [[ "$found" == "false" ]]; then
        MISSING+=("$expected")
    fi
done

# =============================================================================
# Determine overall status
# =============================================================================
HAS_ISSUES=false
[[ ${#ROGUE[@]} -gt 0 ]] || [[ ${#MISSING[@]} -gt 0 ]] && HAS_ISSUES=true

TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

# =============================================================================
# JSON output mode
# =============================================================================
if [[ "$OUTPUT_JSON" == "true" ]]; then
    if [[ ${#ROGUE[@]} -gt 0 ]]; then
        rogue_json=$(printf '%s\n' "${ROGUE[@]}" | jq -R . | jq -s . 2>/dev/null || echo '[]')
    else
        rogue_json='[]'
    fi
    if [[ ${#MISSING[@]} -gt 0 ]]; then
        missing_json=$(printf '%s\n' "${MISSING[@]}" | jq -R . | jq -s . 2>/dev/null || echo '[]')
    else
        missing_json='[]'
    fi
    if [[ ${#OK[@]} -gt 0 ]]; then
        ok_json=$(printf '%s\n' "${OK[@]}" | jq -R . | jq -s . 2>/dev/null || echo '[]')
    else
        ok_json='[]'
    fi

    jq -n \
        --arg host "$HOST" \
        --arg env "$ENV" \
        --arg ts "$TIMESTAMP" \
        --argjson rogue "$rogue_json" \
        --argjson missing "$missing_json" \
        --argjson ok "$ok_json" \
        --argjson has_issues "$HAS_ISSUES" \
        '{
            host: $host,
            env: $env,
            timestamp: $ts,
            has_issues: $has_issues,
            rogue_containers: $rogue,
            missing_containers: $missing,
            healthy_containers: $ok
        }'
    
    # Still send Discord alert even in JSON mode
    if [[ "$HAS_ISSUES" == "true" ]] && [[ -n "$DISCORD_WEBHOOK_URL" ]]; then
        _send_discord_alert
    fi
    
    [[ "$HAS_ISSUES" == "true" ]] && exit 2
    exit 0
fi

# =============================================================================
# Human-readable output
# =============================================================================
if [[ "$QUIET" == "true" ]] && [[ "$HAS_ISSUES" == "false" ]]; then
    exit 0
fi

echo ""
echo -e "${BOLD}════════════════════════════════════════════════════════════════${NC}"
echo -e "${BOLD}  Container Audit - ${HOST} (${ENV})${NC}"
echo -e "${BOLD}  ${TIMESTAMP}${NC}"
echo -e "${BOLD}════════════════════════════════════════════════════════════════${NC}"
echo ""

# Healthy containers
if [[ ${#OK[@]} -gt 0 ]]; then
    echo -e "${BOLD}Healthy containers:${NC}"
    for ctr in "${OK[@]}"; do
        source="${EXPECTED_MAP[$ctr]}"
        echo -e "  ${GREEN}✓${NC} ${ctr}  ${BLUE}(${source})${NC}"
    done
    echo ""
fi

# Rogue containers
if [[ ${#ROGUE[@]} -gt 0 ]]; then
    echo -e "${RED}${BOLD}⚠ Rogue containers (not in manifest or infra):${NC}"
    for ctr in "${ROGUE[@]}"; do
        # Try to find where it was started from
        workdir=$(docker inspect "$ctr" --format '{{ '{{' }}index .Config.Labels "com.docker.compose.project.working_dir"{{ '}}' }}' 2>/dev/null || echo "unknown")
        image=$(docker inspect "$ctr" --format '{{ '{{' }}.Config.Image{{ '}}' }}' 2>/dev/null || echo "unknown")
        echo -e "  ${RED}✗${NC} ${ctr}"
        echo -e "    Image:   ${image}"
        echo -e "    Workdir: ${workdir}"
    done
    echo ""
fi

# Missing containers
if [[ ${#MISSING[@]} -gt 0 ]]; then
    echo -e "${YELLOW}${BOLD}⚠ Missing containers (expected but not running):${NC}"
    for ctr in "${MISSING[@]}"; do
        source="${EXPECTED_MAP[$ctr]}"
        echo -e "  ${YELLOW}!${NC} ${ctr}  ${BLUE}(${source})${NC}"
    done
    echo ""
fi

# Summary
echo -e "${BOLD}────────────────────────────────────────────────────────────────${NC}"
echo -e "  Running: ${#RUNNING[@]}  |  Expected: ${#EXPECTED_MAP[@]}  |  Rogue: ${#ROGUE[@]}  |  Missing: ${#MISSING[@]}"

if [[ "$HAS_ISSUES" == "false" ]]; then
    echo -e "  ${GREEN}${BOLD}✓ All containers accounted for${NC}"
else
    echo -e "  ${RED}${BOLD}✗ Issues detected${NC}"
fi
echo -e "${BOLD}────────────────────────────────────────────────────────────────${NC}"
echo ""

# =============================================================================
# Remove rogue containers (if requested)
# =============================================================================
if [[ "$REMOVE_ROGUE" == "true" ]] && [[ ${#ROGUE[@]} -gt 0 ]]; then
    echo -e "${YELLOW}Removing rogue containers...${NC}"
    for ctr in "${ROGUE[@]}"; do
        workdir=$(docker inspect "$ctr" --format '{{ '{{' }}index .Config.Labels "com.docker.compose.project.working_dir"{{ '}}' }}' 2>/dev/null || echo "")
        
        if [[ -n "$workdir" ]] && [[ -f "${workdir}/docker-compose.yml" ]]; then
            echo -e "  Stopping via compose: ${ctr} (${workdir})"
            (cd "$workdir" && docker compose down --remove-orphans 2>/dev/null) || \
                docker rm -f "$ctr" 2>/dev/null
        else
            echo -e "  Force removing: ${ctr}"
            docker rm -f "$ctr" 2>/dev/null
        fi
        echo -e "  ${GREEN}✓${NC} Removed ${ctr}"
    done
    echo ""
fi

# =============================================================================
# Discord alert
# =============================================================================
if [[ "$HAS_ISSUES" == "true" ]] && [[ -n "$DISCORD_WEBHOOK_URL" ]]; then
    alert_body=""
    
    if [[ ${#ROGUE[@]} -gt 0 ]]; then
        alert_body+="**Rogue containers:**\n"
        for ctr in "${ROGUE[@]}"; do
            alert_body+="• \`${ctr}\`\n"
        done
    fi
    
    if [[ ${#MISSING[@]} -gt 0 ]]; then
        alert_body+="**Missing containers:**\n"
        for ctr in "${MISSING[@]}"; do
            alert_body+="• \`${ctr}\`\n"
        done
    fi

    payload=$(jq -n \
        --arg host "$HOST" \
        --arg env "$ENV" \
        --arg body "$alert_body" \
        --arg ts "$TIMESTAMP" \
        --argjson rogue_count "${#ROGUE[@]}" \
        --argjson missing_count "${#MISSING[@]}" \
        '{
            event: "container_audit",
            host: $host,
            env: $env,
            timestamp: $ts,
            rogue_count: $rogue_count,
            missing_count: $missing_count,
            message: $body
        }')
    
    curl -s -X POST \
        -H "Content-Type: application/json" \
        -d "$payload" \
        "${DISCORD_WEBHOOK_URL}${DISCORD_WEBHOOK_PATH}" \
        --max-time 10 >/dev/null 2>&1 || true
fi

[[ "$HAS_ISSUES" == "true" ]] && exit 2
exit 0
