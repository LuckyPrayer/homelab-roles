---
# Monitoring Stack Role - Main Tasks
# Deploys Grafana, Prometheus, Loki, Alertmanager on argus hosts

- name: Include Infisical secrets
  ansible.builtin.include_tasks: infisical.yml
  when: grafana_enabled | default(false)
  tags: [monitoring, grafana]

- name: Create monitoring directories
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    owner: root
    group: root
    mode: "0755"
  loop:
    - "{{ monitoring_base_dir }}"
    - "{{ monitoring_base_dir }}/grafana"
    - "{{ monitoring_base_dir }}/grafana/provisioning"
    - "{{ monitoring_base_dir }}/grafana/provisioning/datasources"
    - "{{ monitoring_base_dir }}/grafana/provisioning/dashboards"
    - "{{ monitoring_base_dir }}/grafana/provisioning/alerting"
    - "{{ monitoring_base_dir }}/grafana/dashboards"
    - "{{ monitoring_base_dir }}/prometheus"
    - "{{ monitoring_base_dir }}/prometheus/rules"
    - "{{ monitoring_base_dir }}/loki"
    - "{{ monitoring_base_dir }}/alertmanager"
    - "{{ monitoring_base_dir }}/alloy"
  tags: [monitoring]

- name: Template Prometheus configuration
  ansible.builtin.template:
    src: prometheus.yml.j2
    dest: "{{ monitoring_base_dir }}/prometheus/prometheus.yml"
    owner: root
    group: root
    mode: "0644"
  notify: Restart monitoring stack
  tags: [monitoring, prometheus]

- name: Template Prometheus alert rules
  ansible.builtin.template:
    src: alert-rules.yml.j2
    dest: "{{ monitoring_base_dir }}/prometheus/rules/alerts.yml"
    owner: root
    group: root
    mode: "0644"
  notify: Restart monitoring stack
  tags: [monitoring, prometheus]

- name: Template Loki configuration
  ansible.builtin.template:
    src: loki-config.yml.j2
    dest: "{{ monitoring_base_dir }}/loki/loki-config.yml"
    owner: root
    group: root
    mode: "0644"
  notify: Restart monitoring stack
  tags: [monitoring, loki]

- name: Template Alertmanager configuration
  ansible.builtin.template:
    src: alertmanager.yml.j2
    dest: "{{ monitoring_base_dir }}/alertmanager/alertmanager.yml"
    owner: root
    group: root
    mode: "0644"
  notify: Restart monitoring stack
  tags: [monitoring, alertmanager]

- name: Template Alloy configuration
  ansible.builtin.template:
    src: alloy-config.river.j2
    dest: "{{ monitoring_base_dir }}/alloy/config.river"
    owner: root
    group: root
    mode: "0644"
  notify: Restart monitoring stack
  tags: [monitoring, alloy]

- name: Template Grafana datasources
  ansible.builtin.template:
    src: grafana-datasources.yml.j2
    dest: "{{ monitoring_base_dir }}/grafana/provisioning/datasources/datasources.yml"
    owner: root
    group: root
    mode: "0644"
  notify: Restart monitoring stack
  tags: [monitoring, grafana]

- name: Template Grafana alerting configuration
  ansible.builtin.template:
    src: grafana-alerting.yml.j2
    dest: "{{ monitoring_base_dir }}/grafana/provisioning/alerting/alerting.yml"
    owner: root
    group: root
    mode: "0644"
  notify: Restart monitoring stack
  tags: [monitoring, grafana]

- name: Template Grafana alert rules
  ansible.builtin.template:
    src: grafana-alert-rules.yml.j2
    dest: "{{ monitoring_base_dir }}/grafana/provisioning/alerting/alert-rules.yml"
    owner: root
    group: root
    mode: "0644"
  notify: Restart monitoring stack
  tags: [monitoring, grafana]

- name: Template Grafana dashboard provisioning
  ansible.builtin.template:
    src: grafana-dashboards.yml.j2
    dest: "{{ monitoring_base_dir }}/grafana/provisioning/dashboards/dashboards.yml"
    owner: root
    group: root
    mode: "0644"
  tags: [monitoring, grafana]

- name: Copy default Grafana dashboards
  ansible.builtin.copy:
    src: "dashboards/"
    dest: "{{ monitoring_base_dir }}/grafana/dashboards/"
    owner: root
    group: root
    mode: "0644"
  tags: [monitoring, grafana]

- name: Template docker-compose file
  ansible.builtin.template:
    src: docker-compose.yml.j2
    dest: "{{ monitoring_base_dir }}/docker-compose.yml"
    owner: root
    group: root
    mode: "0644"
  notify: Restart monitoring stack
  tags: [monitoring]

- name: Template environment file
  ansible.builtin.template:
    src: env.j2
    dest: "{{ monitoring_base_dir }}/.env"
    owner: root
    group: root
    mode: "0600"
  notify: Restart monitoring stack
  tags: [monitoring]

- name: Ensure homelab network exists
  ansible.builtin.command:
    cmd: docker network create homelab
  register: network_create
  changed_when: network_create.rc == 0
  failed_when: network_create.rc != 0 and 'already exists' not in network_create.stderr
  tags: [monitoring]

- name: Pull monitoring stack images
  ansible.builtin.command:
    cmd: docker compose pull
    chdir: "{{ monitoring_base_dir }}"
  register: monitoring_pull
  changed_when: "'Pull complete' in monitoring_pull.stdout or 'Downloaded' in monitoring_pull.stdout"
  tags: [monitoring]

- name: Start monitoring stack
  ansible.builtin.command:
    cmd: docker compose up -d
    chdir: "{{ monitoring_base_dir }}"
  register: monitoring_up
  changed_when: "'Started' in monitoring_up.stderr or 'Created' in monitoring_up.stderr"
  tags: [monitoring]

- name: Display monitoring stack status
  ansible.builtin.debug:
    msg: "Monitoring stack containers started"
  tags: [monitoring]
