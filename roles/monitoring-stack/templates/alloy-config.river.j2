// Grafana Alloy Configuration
// Generated by Ansible - Do not edit manually
// Collects logs from Docker containers and system logs, sends to Loki

// ============================================================================
// LOGGING
// ============================================================================

logging {
  level  = "info"
  format = "logfmt"
}

// ============================================================================
// LOKI OUTPUT
// ============================================================================

loki.write "default" {
  endpoint {
    url = "http://loki:3100/loki/api/v1/push"
  }
  external_labels = {
    host        = "{{ inventory_hostname }}",
    environment = "{{ env }}",
  }
}

// ============================================================================
// DOCKER CONTAINER LOG COLLECTION
// ============================================================================

// Discover Docker containers
discovery.docker "containers" {
  host = "unix:///var/run/docker.sock"
  refresh_interval = "5s"
}

// Relabel Docker container targets
discovery.relabel "docker" {
  targets = discovery.docker.containers.targets

  // Use container name as label
  rule {
    source_labels = ["__meta_docker_container_name"]
    regex         = "/(.*)"
    target_label  = "container"
  }

  // Extract compose service name
  rule {
    source_labels = ["__meta_docker_container_label_com_docker_compose_service"]
    target_label  = "service"
  }

  // Extract compose project name
  rule {
    source_labels = ["__meta_docker_container_label_com_docker_compose_project"]
    target_label  = "project"
  }

  // Add job label
  rule {
    replacement  = "docker"
    target_label = "job"
  }
}

// Collect Docker container logs
loki.source.docker "containers" {
  host       = "unix:///var/run/docker.sock"
  targets    = discovery.relabel.docker.output
  forward_to = [loki.process.docker.receiver]
  refresh_interval = "5s"
}

// Process Docker logs
loki.process "docker" {
  forward_to = [loki.write.default.receiver]

  // Parse JSON logs from Docker
  stage.json {
    expressions = {
      log    = "log",
      stream = "stream",
      time   = "time",
    }
  }

  // Extract log level
  stage.regex {
    expression = "(?i)(?P<level>debug|info|warn(?:ing)?|error|fatal|critical|panic)"
    source     = "log"
  }

  // Add labels
  stage.labels {
    values = {
      stream = "",
      level  = "",
    }
  }

  // Parse timestamp
  stage.timestamp {
    source = "time"
    format = "RFC3339Nano"
  }

  // Output the log line
  stage.output {
    source = "log"
  }
}

// ============================================================================
// SYSTEM LOG COLLECTION
// ============================================================================

// System logs (/var/log/*.log)
local.file_match "system_logs" {
  path_targets = [{
    __address__ = "localhost",
    __path__    = "/var/log/*.log",
    job         = "varlogs",
    host        = "{{ inventory_hostname }}",
    environment = "{{ env }}",
  }]
}

loki.source.file "system_logs" {
  targets    = local.file_match.system_logs.targets
  forward_to = [loki.process.system.receiver]
}

// Syslog
local.file_match "syslog" {
  path_targets = [{
    __address__ = "localhost",
    __path__    = "/var/log/syslog",
    job         = "syslog",
    host        = "{{ inventory_hostname }}",
    environment = "{{ env }}",
  }]
}

loki.source.file "syslog" {
  targets    = local.file_match.syslog.targets
  forward_to = [loki.process.syslog.receiver]
}

// Auth logs
local.file_match "auth_logs" {
  path_targets = [{
    __address__ = "localhost",
    __path__    = "/var/log/auth.log",
    job         = "auth",
    host        = "{{ inventory_hostname }}",
    environment = "{{ env }}",
  }]
}

loki.source.file "auth_logs" {
  targets    = local.file_match.auth_logs.targets
  forward_to = [loki.process.auth.receiver]
}

// Process system logs
loki.process "system" {
  forward_to = [loki.write.default.receiver]

  stage.regex {
    expression = "(?i)(?P<level>debug|info|warn(?:ing)?|error|fatal|critical|panic)"
  }

  stage.labels {
    values = {
      level = "",
    }
  }
}

// Process syslog
loki.process "syslog" {
  forward_to = [loki.write.default.receiver]

  stage.regex {
    expression = "(?P<priority><\\d+>)?(?P<timestamp>\\w+\\s+\\d+\\s+[\\d:]+)\\s+(?P<syslog_host>\\S+)\\s+(?P<program>[^:\\[]+)(?:\\[(?P<pid>\\d+)\\])?:\\s*(?P<message>.*)"
  }

  stage.labels {
    values = {
      program     = "",
      syslog_host = "",
    }
  }
}

// Process auth logs
loki.process "auth" {
  forward_to = [loki.write.default.receiver]

  stage.regex {
    expression = "(?P<timestamp>\\w+\\s+\\d+\\s+[\\d:]+)\\s+(?P<auth_host>\\S+)\\s+(?P<service>[^:\\[]+)(?:\\[(?P<pid>\\d+)\\])?:\\s*(?P<message>.*)"
  }

  stage.labels {
    values = {
      service = "",
    }
  }

  // Match failed auth attempts and mark as error
  stage.match {
    selector = "{job=\"auth\"} |~ \"(?i)(failed|invalid|unauthorized|denied|rejected)\""
    
    stage.static_labels {
      values = {
        level = "error",
      }
    }
  }
}

// ============================================================================
// JOURNAL LOG COLLECTION
// ============================================================================

// Collect systemd journal logs
loki.source.journal "journal" {
  forward_to = [loki.process.journal.receiver]
  
  labels = {
    job         = "journal",
    host        = "{{ inventory_hostname }}",
    environment = "{{ env }}",
  }
  
  // Collect all journal entries
  relabel_rules = loki.relabel.journal.rules
}

// Relabel rules for journal logs
loki.relabel "journal" {
  forward_to = []
  
  rule {
    source_labels = ["__journal__systemd_unit"]
    target_label  = "unit"
  }
}

// Process journal logs
loki.process "journal" {
  forward_to = [loki.write.default.receiver]

  // Extract systemd unit
  stage.labels {
    values = {
      unit = "_SYSTEMD_UNIT",
    }
  }

  // Map priority to level
  stage.label_drop {
    values = ["__journal__systemd_unit"]
  }
}
