# Grafana Alert Rules Configuration
# Generated by Ansible - Do not edit manually
# Defines alert rules for log-based security monitoring

apiVersion: 1

groups:
  - orgId: 1
    name: Security Alerts
    folder: Security
    interval: 1m
    rules:
      # SSH Failed Login Alert - triggers when multiple failed SSH attempts detected
      - uid: ssh-failed-login
        title: SSH Failed Login Attempts
        condition: C
        data:
          - refId: A
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: loki
            model:
              expr: 'count_over_time({job="journal",syslog_identifier="sshd-session"} |~ "Invalid user" [5m])'
              instant: false
              range: true
              refId: A
          - refId: B
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: __expr__
            model:
              conditions:
                - evaluator:
                    params: []
                    type: gt
                  operator:
                    type: and
                  query:
                    params:
                      - B
                  reducer:
                    params: []
                    type: last
                  type: query
              datasource:
                type: __expr__
                uid: __expr__
              expression: A
              reducer: last
              refId: B
              type: reduce
          - refId: C
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: __expr__
            model:
              conditions:
                - evaluator:
                    params:
                      - 3
                    type: gt
                  operator:
                    type: and
                  query:
                    params:
                      - C
                  reducer:
                    params: []
                    type: last
                  type: query
              datasource:
                type: __expr__
                uid: __expr__
              expression: B
              refId: C
              type: threshold
        noDataState: OK
        execErrState: Error
        for: 0s
        annotations:
          description: "{{ '{{' }} $values.B {{ '}}' }} failed SSH login attempts detected in the last 5 minutes on {{ inventory_hostname }}"
          summary: Multiple SSH failed login attempts detected
        labels:
          severity: warning
          category: security
          alert_type: ssh_failure

      # SSH Brute Force Alert - triggers on high volume of failed attempts
      - uid: ssh-brute-force
        title: SSH Brute Force Attack
        condition: C
        data:
          - refId: A
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: loki
            model:
              expr: 'count_over_time({job="journal",syslog_identifier="sshd-session"} |~ "Invalid user|Failed|authentication failure" [5m])'
              instant: false
              range: true
              refId: A
          - refId: B
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: __expr__
            model:
              datasource:
                type: __expr__
                uid: __expr__
              expression: A
              reducer: last
              refId: B
              type: reduce
          - refId: C
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: __expr__
            model:
              conditions:
                - evaluator:
                    params:
                      - 10
                    type: gt
              datasource:
                type: __expr__
                uid: __expr__
              expression: B
              refId: C
              type: threshold
        noDataState: OK
        execErrState: Error
        for: 0s
        annotations:
          description: "{{ '{{' }} $values.B {{ '}}' }} failed authentication attempts in 5 minutes - possible brute force attack"
          summary: Possible SSH brute force attack detected
        labels:
          severity: critical
          category: security
          alert_type: brute_force

      # SSH Root Login Attempt
      - uid: ssh-root-login
        title: SSH Root Login Detected
        condition: C
        data:
          - refId: A
            relativeTimeRange:
              from: 60
              to: 0
            datasourceUid: loki
            model:
              expr: 'count_over_time({job="journal",syslog_identifier="sshd-session"} |~ "Accepted.*root" [1m])'
              instant: false
              range: true
              refId: A
          - refId: B
            relativeTimeRange:
              from: 60
              to: 0
            datasourceUid: __expr__
            model:
              datasource:
                type: __expr__
                uid: __expr__
              expression: A
              reducer: last
              refId: B
              type: reduce
          - refId: C
            relativeTimeRange:
              from: 60
              to: 0
            datasourceUid: __expr__
            model:
              conditions:
                - evaluator:
                    params:
                      - 0
                    type: gt
              datasource:
                type: __expr__
                uid: __expr__
              expression: B
              refId: C
              type: threshold
        noDataState: OK
        execErrState: Error
        for: 0s
        annotations:
          description: "SSH root login detected on {{ inventory_hostname }}"
          summary: Root user SSH login detected
        labels:
          severity: info
          category: security
          alert_type: root_login

  - orgId: 1
    name: Log Error Alerts
    folder: Logs
    interval: 1m
    rules:
      # High Error Rate in Container Logs
      - uid: container-error-rate
        title: High Container Error Rate
        condition: C
        data:
          - refId: A
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: loki
            model:
              expr: 'sum(count_over_time({job="docker"} |~ "(?i)(error|fatal|panic|exception)" [5m]))'
              instant: false
              range: true
              refId: A
          - refId: B
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: __expr__
            model:
              datasource:
                type: __expr__
                uid: __expr__
              expression: A
              reducer: last
              refId: B
              type: reduce
          - refId: C
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: __expr__
            model:
              conditions:
                - evaluator:
                    params:
                      - 50
                    type: gt
              datasource:
                type: __expr__
                uid: __expr__
              expression: B
              refId: C
              type: threshold
        noDataState: OK
        execErrState: Error
        for: 2m
        annotations:
          description: "{{ '{{' }} $values.B {{ '}}' }} error log entries detected across containers in the last 5 minutes"
          summary: High error rate in container logs
        labels:
          severity: warning
          category: logs

      # Systemd Service Failures
      - uid: systemd-service-failure
        title: Systemd Service Failed
        condition: C
        data:
          - refId: A
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: loki
            model:
              expr: 'count_over_time({job="journal",syslog_identifier="systemd"} |~ "(?i)(failed|failure|error)" [5m])'
              instant: false
              range: true
              refId: A
          - refId: B
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: __expr__
            model:
              datasource:
                type: __expr__
                uid: __expr__
              expression: A
              reducer: last
              refId: B
              type: reduce
          - refId: C
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: __expr__
            model:
              conditions:
                - evaluator:
                    params:
                      - 3
                    type: gt
              datasource:
                type: __expr__
                uid: __expr__
              expression: B
              refId: C
              type: threshold
        noDataState: OK
        execErrState: Error
        for: 1m
        annotations:
          description: "Systemd service failures detected on {{ inventory_hostname }}"
          summary: Systemd service failure detected
        labels:
          severity: warning
          category: system

      # Kernel/System Critical Messages
      - uid: kernel-critical
        title: Kernel Critical Messages
        condition: C
        data:
          - refId: A
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: loki
            model:
              expr: 'count_over_time({job="journal",syslog_identifier="kernel"} |~ "(?i)(critical|emergency|oops|bug|panic)" [5m])'
              instant: false
              range: true
              refId: A
          - refId: B
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: __expr__
            model:
              datasource:
                type: __expr__
                uid: __expr__
              expression: A
              reducer: last
              refId: B
              type: reduce
          - refId: C
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: __expr__
            model:
              conditions:
                - evaluator:
                    params:
                      - 0
                    type: gt
              datasource:
                type: __expr__
                uid: __expr__
              expression: B
              refId: C
              type: threshold
        noDataState: OK
        execErrState: Error
        for: 0s
        annotations:
          description: "Critical kernel messages detected on {{ inventory_hostname }}"
          summary: Kernel critical message detected
        labels:
          severity: critical
          category: system

  - orgId: 1
    name: Backup Alerts
    folder: Backups
    interval: 5m
    rules:
      # Backup Failure Detection
      - uid: backup-failure
        title: Backup Failure Detected
        condition: C
        data:
          - refId: A
            relativeTimeRange:
              from: 3600
              to: 0
            datasourceUid: loki
            model:
              expr: 'count_over_time({job="varlogs",filename=~".*backup.*"} |~ "(?i)(failed|error|failure)" [1h])'
              instant: false
              range: true
              refId: A
          - refId: B
            relativeTimeRange:
              from: 3600
              to: 0
            datasourceUid: __expr__
            model:
              datasource:
                type: __expr__
                uid: __expr__
              expression: A
              reducer: last
              refId: B
              type: reduce
          - refId: C
            relativeTimeRange:
              from: 3600
              to: 0
            datasourceUid: __expr__
            model:
              conditions:
                - evaluator:
                    params:
                      - 0
                    type: gt
              datasource:
                type: __expr__
                uid: __expr__
              expression: B
              refId: C
              type: threshold
        noDataState: OK
        execErrState: Error
        for: 0s
        annotations:
          description: "Backup failure detected in logs on {{ inventory_hostname }}"
          summary: Backup operation failed
        labels:
          severity: critical
          category: backup
