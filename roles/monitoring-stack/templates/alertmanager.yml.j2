# Alertmanager Configuration
# Generated by Ansible - Do not edit manually
# Routes alerts to Discord via the homelab Discord bot

global:
  resolve_timeout: 5m

route:
  group_by: ['alertname', 'severity', 'instance']
  group_wait: 30s
  group_interval: 5m
  repeat_interval: 4h
  receiver: 'discord-webhook'
  routes:
    # Critical alerts - faster notification
    - match:
        severity: critical
      receiver: 'discord-webhook'
      group_wait: 10s
      repeat_interval: 1h
      continue: true
    # Warning alerts
    - match:
        severity: warning
      receiver: 'discord-webhook'
      repeat_interval: 4h
    # Container alerts
    - match_re:
        alertname: 'Container.*'
      receiver: 'discord-webhook'
      group_by: ['alertname', 'name']
      repeat_interval: 2h

receivers:
  - name: 'discord-webhook'
    webhook_configs:
{% if alertmanager_discord_webhook %}
      - url: '{{ alertmanager_discord_webhook }}'
        send_resolved: true
        http_config:
          follow_redirects: true
{% else %}
      # Discord webhook not configured - configure via:
      # alertmanager_discord_webhook: http://hephaestus-{{ env }}:8085/webhook/alert
      []
{% endif %}

# Templates for custom notification formatting
templates: []

inhibit_rules:
  # Don't alert for warning if critical is already firing
  - source_match:
      severity: 'critical'
    target_match:
      severity: 'warning'
    equal: ['alertname', 'instance']
  
  # Don't alert for individual containers if host is down
  - source_match:
      alertname: 'HostDown'
    target_match_re:
      alertname: 'Container.*'
    equal: ['instance']
