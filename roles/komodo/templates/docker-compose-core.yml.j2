version: "3.9"

# Komodo Core Stack - Full Management Platform
# Deploys Core + MongoDB + Local Periphery Agent
# This runs on the designated management host (e.g., argus)

services:
  # ============================================================================
  # KOMODO CORE - Web UI and API Server
  # ============================================================================
  komodo-core:
    image: ghcr.io/mbecker20/komodo:{{ komodo_version }}
    container_name: komodo-core
    restart: unless-stopped
    depends_on:
      - komodo-mongo
    environment:
      KOMODO_TITLE: "{{ komodo_title }}"
      KOMODO_HOST: "{{ komodo_host }}"
      KOMODO_PASSKEY: "${KOMODO_PASSKEY}"
      KOMODO_DATABASE_URI: "mongodb://komodo-mongo:27017/komodo"
      KOMODO_LOCAL_AUTH: "true"
      KOMODO_ENABLE_NEW_USERS: "true"
      # Initial admin user - only used on first startup
      KOMODO_INIT_ADMIN_USERNAME: "${KOMODO_INIT_ADMIN_USERNAME:-admin}"
      KOMODO_INIT_ADMIN_PASSWORD: "${KOMODO_INIT_ADMIN_PASSWORD:-changeme}"
      # Optional: Webhook secret for GitHub/GitLab integrations
      KOMODO_WEBHOOK_SECRET: "${KOMODO_WEBHOOK_SECRET:-}"
    ports:
      - "9120:9120"
    volumes:
      # Mount config file for git providers and other advanced settings
      - {{ stacks_base_dir | default('/opt/stacks') }}/komodo/core-config/config.toml:/config/config.toml:ro
      # Mount resources directory for ResourceSync (files_on_host mode)
      - {{ stacks_base_dir | default('/opt/stacks') }}/komodo/resources:/syncs
    # Note: Traefik labels are not used here since Traefik runs on a different host.
    # Routing is configured via traefik_proxy_backends in the inventory.
    logging:
      driver: {{ komodo_logging_driver }}
      options:
        max-size: "{{ komodo_logging_max_size }}"
        max-file: "{{ komodo_logging_max_file }}"
{% if komodo_core_memory_limit is defined %}
    deploy:
      resources:
        limits:
          memory: {{ komodo_core_memory_limit }}
{% endif %}
    networks:
      - komodo-internal
      - homelab

  # ============================================================================
  # MONGODB - Komodo Database
  # ============================================================================
  komodo-mongo:
    image: mongo:{{ komodo_mongo_version }}
    container_name: komodo-mongo
    restart: unless-stopped
    command: --quiet --logpath /dev/null
    volumes:
      - {{ komodo_mongo_volume }}:/data/db
    logging:
      driver: {{ komodo_logging_driver }}
      options:
        max-size: "{{ komodo_logging_max_size }}"
        max-file: "{{ komodo_logging_max_file }}"
{% if komodo_mongo_memory_limit is defined %}
    deploy:
      resources:
        limits:
          memory: {{ komodo_mongo_memory_limit }}
{% endif %}
    networks:
      - komodo-internal

  # ============================================================================
  # LOCAL PERIPHERY AGENT - Monitors containers on this host
  # ============================================================================
  komodo-periphery:
    image: ghcr.io/mbecker20/periphery:{{ komodo_version }}
    container_name: komodo-periphery
    restart: unless-stopped
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - /proc:/proc:ro
      # Mount periphery config for git providers
      - {{ stacks_base_dir | default('/opt/stacks') }}/komodo/periphery-config/config.toml:/config/config.toml:ro
      # Mount stacks directory for Komodo to see Ansible-deployed containers
      - {{ stacks_base_dir | default('/opt/stacks') }}:{{ stacks_base_dir | default('/opt/stacks') }}:ro
      # Mount monitoring directory (separate from stacks)
      - /opt/monitoring:/opt/monitoring:ro
      # Mount repos directory for cloned repositories
      - /etc/komodo/repos:/etc/komodo/repos
    environment:
      PERIPHERY_PASSKEY: "${KOMODO_PASSKEY}"
      PERIPHERY_CONFIG_PATHS: "/config/config.toml"
    ports:
      - "{{ komodo_periphery_port }}:8120"
    logging:
      driver: {{ komodo_logging_driver }}
      options:
        max-size: "{{ komodo_logging_max_size }}"
        max-file: "{{ komodo_logging_max_file }}"
{% if komodo_periphery_memory_limit is defined %}
    deploy:
      resources:
        limits:
          memory: {{ komodo_periphery_memory_limit }}
{% endif %}
    networks:
      - komodo-internal

volumes:
  {{ komodo_mongo_volume }}:

networks:
  komodo-internal:
    name: komodo-internal
  homelab:
    name: homelab
    external: true
