# Komodo Resource Sync Configuration
# This file defines stacks and procedures for the homelab
# Managed by Ansible - regenerated on deployment
# 
# NOTE: Backups are handled via systemd timers on each host, not via Komodo
# Manual backup: ssh <host> "sudo /opt/scripts/komodo-backup.sh all full"

# =============================================================================
# SERVERS (Periphery Agents)
# =============================================================================
{% if komodo_mode == 'core' %}
[[server]]
name = "{{ inventory_hostname }}"
description = "Komodo Core Host - {{ env | default('dev') }} environment"
tags = ["{{ env | default('dev') }}", "core", "docker"]
[server.config]
address = "http://komodo-periphery:{{ komodo_periphery_port | default(8120) }}"
enabled = true

{% for host in groups['docker_hosts'] | default([]) if host != inventory_hostname and hostvars[host].komodo_mode | default('disabled') == 'periphery' %}
[[server]]
name = "{{ host }}"
description = "Docker Host - {{ hostvars[host].env | default('dev') }} environment"
tags = ["{{ hostvars[host].env | default('dev') }}", "periphery", "docker"]
[server.config]
address = "http://{{ hostvars[host].ansible_host }}:{{ hostvars[host].komodo_periphery_port | default(8120) }}"
enabled = true
{% endfor %}
{% endif %}

# =============================================================================
# PROCEDURES - Deployment
# =============================================================================
# NOTE: Infrastructure stacks (harbor, traefik, monitoring) are managed
# exclusively by Ansible and are NOT registered in Komodo.
# Komodo only manages application stacks from homelab-apps.

{% if komodo_app_stacks is defined %}
[[procedure]]
name = "deploy-all-{{ env | default('dev') }}"
description = "Deploy all application stacks"
tags = ["{{ env | default('dev') }}", "deployment"]

[[procedure.config.stage]]
name = "Deploy Applications"
executions = [
{% for host_name, apps in komodo_app_stacks.items() %}
{% if host_name in groups['docker_hosts'] | default([]) %}
{% for app_name in apps | sort %}
  { execution.type = "DeployStack", execution.params.stack = "{{ app_name }}-{{ host_name }}" },
{% endfor %}
{% endif %}
{% endfor %}
]
{% endif %}

# =============================================================================
# PROCEDURES - Maintenance
# =============================================================================
{% if komodo_app_stacks is defined %}
[[procedure]]
name = "restart-all-{{ env | default('dev') }}"
description = "Restart all application stacks"
tags = ["{{ env | default('dev') }}", "maintenance"]

[[procedure.config.stage]]
name = "Restart Applications"
executions = [
{% for host_name, apps in komodo_app_stacks.items() %}
{% if host_name in groups['docker_hosts'] | default([]) %}
{% for app_name in apps | sort %}
  { execution.type = "RestartStack", execution.params.stack = "{{ app_name }}-{{ host_name }}" },
{% endfor %}
{% endif %}
{% endfor %}
]
{% endif %}

# =============================================================================
# BACKUP/RESTORE REFERENCE
# =============================================================================
# Backups are handled via systemd timers on each host, not via Komodo.
#
# Manual restore examples:
#   ssh orion-dev "/opt/scripts/komodo-restore.sh n8n latest"
#   ssh orion-dev "/opt/scripts/komodo-restore.sh mealie latest"
#   ssh orion-dev "/opt/scripts/komodo-restore.sh vaultwarden latest"
#
# Manual backup examples:
#   ssh orion-dev "/opt/scripts/komodo-backup.sh all full"
# =============================================================================

# =============================================================================
# STACKS - Application Stacks (from homelab-apps manifest)
# =============================================================================
# Dynamically generated from manifest.yml host-to-app mappings.
# Apps are deployed by the homelab-apps role to /opt/apps/<app>/ with
# symlinks at /opt/stacks/<app>. Secrets are in .env files (not infisical run).
# Komodo can start/stop/restart these stacks directly.
{% if komodo_app_stacks is defined %}
{% for host_name, apps in komodo_app_stacks.items() %}
{% if host_name in groups['docker_hosts'] | default([]) %}
{% for app_name in apps | sort %}

[[stack]]
name = "{{ app_name }}-{{ host_name }}"
description = "{{ app_name | replace('-', ' ') | title }} (managed by homelab-apps)"
tags = ["{{ hostvars[host_name].env | default(env | default('dev')) }}", "application", "homelab-apps"]
[stack.config]
server = "{{ host_name }}"
project_name = "{{ app_name }}"
files_on_host = true
run_directory = "/opt/stacks/{{ app_name }}"
file_paths = ["docker-compose.yml"]
env_file_path = ".env"
{% endfor %}
{% endif %}
{% endfor %}
{% endif %}

# =============================================================================
# HOMELAB-APPS REFERENCE
# =============================================================================
# Applications above are managed via the homelab-apps Git repository.
# - All app definitions live in homelab-apps/manifest.yml
# - Each app has its own config.yml with backup/restore settings
# - Deploy apps via: ./scripts/run-playbook.sh --env=dev deploy-all --tags homelab-apps
# - Or manually: ssh <host> "/opt/apps/scripts/deploy.sh <app>"
#
# To add a new application:
#   1. Create folder in homelab-apps repo (e.g., my-app/)
#   2. Add docker-compose.yml with ${VAR} for secrets
#   3. Add config.yml with backup/secrets configuration
#   4. Add to manifest.yml host profiles or apps list
#   5. Push to Git and run deploy playbook
#   6. Re-deploy komodo role to register the new stack in ResourceSync
