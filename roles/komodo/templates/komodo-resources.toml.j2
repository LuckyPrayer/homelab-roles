# Komodo Resource Sync Configuration
# This file defines stacks and procedures for the homelab
# Managed by Ansible - regenerated on deployment
# 
# NOTE: Backups are handled via systemd timers on each host, not via Komodo
# Manual backup: ssh <host> "sudo /opt/scripts/komodo-backup.sh all full"

# =============================================================================
# SERVERS (Periphery Agents)
# =============================================================================
{% if komodo_mode == 'core' %}
[[server]]
name = "{{ inventory_hostname }}"
description = "Komodo Core Host - {{ env | default('dev') }} environment"
tags = ["{{ env | default('dev') }}", "core", "docker"]
[server.config]
address = "http://localhost:{{ komodo_periphery_port | default(8120) }}"
enabled = true

{% for host in groups['docker_hosts'] | default([]) if host != inventory_hostname and hostvars[host].komodo_mode | default('disabled') == 'periphery' %}
[[server]]
name = "{{ host }}"
description = "Docker Host - {{ hostvars[host].env | default('dev') }} environment"
tags = ["{{ hostvars[host].env | default('dev') }}", "periphery", "docker"]
[server.config]
address = "http://{{ hostvars[host].ansible_host }}:{{ hostvars[host].komodo_periphery_port | default(8120) }}"
enabled = true
{% endfor %}
{% endif %}

# =============================================================================
# STACKS - Harbor Registry (hephaestus)
# =============================================================================
{% if 'hephaestus-dev' in groups['docker_hosts'] | default([]) or 'hephaestus-prod' in groups['docker_hosts'] | default([]) %}
[[stack]]
name = "harbor-{{ env | default('dev') }}"
description = "Harbor Container Registry"
tags = ["{{ env | default('dev') }}", "registry", "infrastructure"]
deploy = true
[stack.config]
server = "hephaestus-{{ env | default('dev') }}"
run_directory = "/opt/infrastructure/harbor"
file_paths = ["docker-compose.yml"]
{% endif %}

# =============================================================================
# STACKS - Orion Infrastructure (Traefik only - apps via homelab-apps)
# =============================================================================
{% if 'orion-dev' in groups['docker_hosts'] | default([]) or 'orion-prod' in groups['docker_hosts'] | default([]) %}
[[stack]]
name = "traefik-{{ env | default('dev') }}"
description = "Traefik Reverse Proxy"
tags = ["{{ env | default('dev') }}", "proxy", "infrastructure"]
deploy = true
[stack.config]
server = "orion-{{ env | default('dev') }}"
run_directory = "/opt/stacks/traefik"
file_paths = ["docker-compose.yml"]
{% endif %}

# =============================================================================
# STACKS - Monitoring (argus)
# =============================================================================
# NOTE: The monitoring stack (Prometheus, Grafana, Loki, etc.) is deployed as a
# single stack at {{ monitoring_base_dir | default('/opt/infrastructure/monitoring') }} by the monitoring-stack role.
# It's not separated into individual stacks like other services.
{% if 'argus-dev' in groups['docker_hosts'] | default([]) or 'argus-prod' in groups['docker_hosts'] | default([]) %}
[[stack]]
name = "monitoring-{{ env | default('dev') }}"
description = "Monitoring Stack (Prometheus, Grafana, Loki, Alertmanager)"
tags = ["{{ env | default('dev') }}", "monitoring", "infrastructure"]
deploy = true
[stack.config]
server = "argus-{{ env | default('dev') }}"
run_directory = "{{ monitoring_base_dir | default('/opt/infrastructure/monitoring') }}"
file_paths = ["docker-compose.yml"]
{% endif %}

# =============================================================================
# PROCEDURES - Deployment
# =============================================================================
[[procedure]]
name = "deploy-all-{{ env | default('dev') }}"
description = "Deploy all infrastructure and application stacks"
tags = ["{{ env | default('dev') }}", "deployment"]

[[procedure.config.stage]]
name = "Deploy Infrastructure"
executions = [
{% if 'hephaestus-dev' in groups['docker_hosts'] | default([]) or 'hephaestus-prod' in groups['docker_hosts'] | default([]) %}
  { execution.type = "DeployStack", execution.params.stack = "harbor-{{ env | default('dev') }}" },
{% endif %}
{% if 'orion-dev' in groups['docker_hosts'] | default([]) or 'orion-prod' in groups['docker_hosts'] | default([]) %}
  { execution.type = "DeployStack", execution.params.stack = "traefik-{{ env | default('dev') }}" },
{% endif %}
{% if 'argus-dev' in groups['docker_hosts'] | default([]) or 'argus-prod' in groups['docker_hosts'] | default([]) %}
  { execution.type = "DeployStack", execution.params.stack = "monitoring-{{ env | default('dev') }}" },
{% endif %}
]

{% if komodo_app_stacks is defined %}
[[procedure.config.stage]]
name = "Deploy Applications"
executions = [
{% for host_name, apps in komodo_app_stacks.items() %}
{% if host_name in groups['docker_hosts'] | default([]) %}
{% for app_name in apps | sort %}
  { execution.type = "DeployStack", execution.params.stack = "{{ app_name }}-{{ host_name }}" },
{% endfor %}
{% endif %}
{% endfor %}
]
{% endif %}

# =============================================================================
# PROCEDURES - Maintenance
# =============================================================================
[[procedure]]
name = "restart-all-{{ env | default('dev') }}"
description = "Restart all infrastructure and application stacks"
tags = ["{{ env | default('dev') }}", "maintenance"]

[[procedure.config.stage]]
name = "Restart Infrastructure"
executions = [
{% if 'hephaestus-dev' in groups['docker_hosts'] | default([]) or 'hephaestus-prod' in groups['docker_hosts'] | default([]) %}
  { execution.type = "RestartStack", execution.params.stack = "harbor-{{ env | default('dev') }}" },
{% endif %}
{% if 'orion-dev' in groups['docker_hosts'] | default([]) or 'orion-prod' in groups['docker_hosts'] | default([]) %}
  { execution.type = "RestartStack", execution.params.stack = "traefik-{{ env | default('dev') }}" },
{% endif %}
{% if 'argus-dev' in groups['docker_hosts'] | default([]) or 'argus-prod' in groups['docker_hosts'] | default([]) %}
  { execution.type = "RestartStack", execution.params.stack = "monitoring-{{ env | default('dev') }}" },
{% endif %}
]

{% if komodo_app_stacks is defined %}
[[procedure.config.stage]]
name = "Restart Applications"
executions = [
{% for host_name, apps in komodo_app_stacks.items() %}
{% if host_name in groups['docker_hosts'] | default([]) %}
{% for app_name in apps | sort %}
  { execution.type = "RestartStack", execution.params.stack = "{{ app_name }}-{{ host_name }}" },
{% endfor %}
{% endif %}
{% endfor %}
]
{% endif %}

# =============================================================================
# PROCEDURES - Restore from B2 Backups (Disaster Recovery)
# =============================================================================
# NOTE: Backup/restore commands must be run manually via SSH or through
# Komodo Actions (defined separately). The RunCommand execution type does not
# exist in Komodo ResourceSync.
#
# Manual restore examples:
#   ssh orion-dev "/opt/scripts/komodo-restore.sh n8n latest"
#   ssh orion-dev "/opt/scripts/komodo-restore.sh mealie latest"
#   ssh orion-dev "/opt/scripts/komodo-restore.sh vaultwarden latest"
#   ssh hephaestus-dev "/opt/scripts/komodo-restore.sh harbor latest"
#
# Manual backup examples:
#   ssh orion-dev "/opt/scripts/komodo-backup.sh all full"
#   ssh hephaestus-dev "/opt/scripts/komodo-backup.sh harbor full"
# =============================================================================

# =============================================================================
# STACKS - Application Stacks (from homelab-apps manifest)
# =============================================================================
# Dynamically generated from manifest.yml host-to-app mappings.
# Apps are deployed by the homelab-apps role to /opt/apps/<app>/ with
# symlinks at /opt/stacks/<app>. Secrets are in .env files (not infisical run).
# Komodo can start/stop/restart these stacks directly.
{% if komodo_app_stacks is defined %}
{% for host_name, apps in komodo_app_stacks.items() %}
{% if host_name in groups['docker_hosts'] | default([]) %}
{% for app_name in apps | sort %}

[[stack]]
name = "{{ app_name }}-{{ host_name }}"
description = "{{ app_name | replace('-', ' ') | title }} (managed by homelab-apps)"
tags = ["{{ hostvars[host_name].env | default(env | default('dev')) }}", "application", "homelab-apps"]
[stack.config]
server = "{{ host_name }}"
run_directory = "/opt/stacks/{{ app_name }}"
file_paths = ["docker-compose.yml"]
env_file_path = ".env"
{% endfor %}
{% endif %}
{% endfor %}
{% endif %}

# =============================================================================
# HOMELAB-APPS REFERENCE
# =============================================================================
# Applications above are managed via the homelab-apps Git repository.
# - All app definitions live in homelab-apps/manifest.yml
# - Each app has its own config.yml with backup/restore settings
# - Deploy apps via: ./scripts/run-playbook.sh --env=dev deploy-all --tags homelab-apps
# - Or manually: ssh <host> "/opt/apps/scripts/deploy.sh <app>"
#
# To add a new application:
#   1. Create folder in homelab-apps repo (e.g., my-app/)
#   2. Add docker-compose.yml with ${VAR} for secrets
#   3. Add config.yml with backup/secrets configuration
#   4. Add to manifest.yml host profiles or apps list
#   5. Push to Git and run deploy playbook
#   6. Re-deploy komodo role to register the new stack in ResourceSync
