version: "3.9"

# Uptime Kuma - Status Monitoring
# Deployed by Ansible to pharos (AWS cloud hosts)
# Purpose: External monitoring of homelab services from outside the network

services:
  uptime-kuma:
    image: {{ uptime_kuma_image | default('louislam/uptime-kuma:1') }}
    container_name: {{ uptime_kuma_container_name | default('uptime-kuma') }}
    restart: unless-stopped
    environment:
      - TZ={{ uptime_kuma_timezone | default('America/Toronto') }}
    volumes:
      - ./data:/app/data
    ports:
      - "{{ uptime_kuma_port | default(3001) }}:3001"
    networks:
      - {{ uptime_kuma_network | default('uptime-kuma-net') }}
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    cap_add:
      - CHOWN        # Required for data directory ownership
      - DAC_OVERRIDE # Required: root runs without DAC_OVERRIDE after cap_drop ALL, needs this to write node-owned data files
      - SETUID       # Required for startup user switching
      - SETGID       # Required for startup group switching
      - NET_RAW      # Required for ping monitoring
{% if uptime_kuma_memory_limit is defined %}
    deploy:
      resources:
        limits:
          memory: {{ uptime_kuma_memory_limit }}
{% if uptime_kuma_memory_reservation is defined %}
        reservations:
          memory: {{ uptime_kuma_memory_reservation }}
{% endif %}
{% endif %}
    healthcheck:
      test: ["CMD-SHELL", "node /app/extra/healthcheck.js || exit 1"]
      interval: 60s
      timeout: 10s
      retries: 3
      start_period: 30s

networks:
  {{ uptime_kuma_network | default('uptime-kuma-net') }}:
    external: true
