# Docker Compose for Oracle - Homelab AI Support Agent (Claude Code CLI)
# Generated by Ansible - Do not edit manually

services:
  oracle:
    image: {{ oracle_image | default('homelab-oracle:latest') }}
    container_name: {{ oracle_container_name | default('homelab-oracle') }}
    build:
      context: /opt/oracle
      dockerfile: Dockerfile
    restart: unless-stopped
    # User is defined in Dockerfile (oracle:3100)
    environment:
      # Discord Configuration
      - DISCORD_TOKEN=${DISCORD_TOKEN}
      - DISCORD_GUILD_ID={{ oracle_guild_id | default(ai_agent_guild_id | default('')) }}
      - COMMAND_PREFIX={{ oracle_command_prefix | default('!') }}
      - ENVIRONMENT={{ env }}
      - HOME=/home/oracle
      
      # Claude Code CLI Configuration
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - CODEBASE_PATH=/app/codebase
      
      # Channel Provisioning
      - AUTO_PROVISION_CHANNELS={{ oracle_auto_provision_channels | default('true') }}
      - AGENT_CATEGORY_NAME={{ oracle_category_name | default('Homelab AI') }}
      - AGENT_CHANNEL_NAME={{ oracle_channel_name | default('oracle') }}
      
      # Behavior Settings
      - AUTO_RESPOND={{ oracle_auto_respond | default('true') }}
      - AUTO_REMEDIATE={{ oracle_auto_remediate | default('false') }}
      
      # Channel IDs (optional - will auto-provision if not set)
{% if oracle_channels is defined %}
{% if oracle_channels.alerts is defined %}
      - CHANNEL_ALERTS={{ oracle_channels.alerts }}
{% endif %}
{% if oracle_channels.critical is defined %}
      - CHANNEL_CRITICAL={{ oracle_channels.critical }}
{% endif %}
{% if oracle_channels.status is defined %}
      - CHANNEL_STATUS={{ oracle_channels.status }}
{% endif %}
{% if oracle_channels.infrastructure is defined %}
      - CHANNEL_INFRASTRUCTURE={{ oracle_channels.infrastructure }}
{% endif %}
{% if oracle_channels.docker is defined %}
      - CHANNEL_DOCKER={{ oracle_channels.docker }}
{% endif %}
{% if oracle_channels.oracle is defined %}
      - CHANNEL_AI_AGENT={{ oracle_channels.oracle }}
{% endif %}
{% endif %}
    
    volumes:
      # Agent logs
      - /opt/oracle/logs:/app/logs
      # Mount homelab codebase for Claude to search
      # In dev environment, mount as read-write for edit capabilities
{% if env == 'dev' %}
      - {{ oracle_codebase_path | default('/opt/homelab') }}:/app/codebase:rw
{% else %}
      - {{ oracle_codebase_path | default('/opt/homelab') }}:/app/codebase:ro
{% endif %}
      # Docker socket for container management (local to this host)
      - /var/run/docker.sock:/var/run/docker.sock:ro
      # SSH credentials for Oracle user (remote host access)
      - {{ oracle_home | default('/home/oracle') }}/.ssh/id_ed25519:/home/oracle/.ssh/id_ed25519:ro
      - {{ oracle_home | default('/home/oracle') }}/.ssh/id_ed25519.pub:/home/oracle/.ssh/id_ed25519.pub:ro
      # SSH config for host aliases and jump settings
      - /opt/oracle/ssh_config:/home/oracle/.ssh/config:ro
    
    networks:
      - homelab
    
{% if oracle_traefik_enabled | default(false) %}
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.oracle.rule=Host(`{{ oracle_hostname }}`)"
      - "traefik.http.routers.oracle.entrypoints=websecure"
      - "traefik.http.routers.oracle.tls=true"
      - "traefik.http.routers.oracle.tls.certresolver=letsencrypt"
      - "traefik.http.services.oracle.loadbalancer.server.port=8080"
{% endif %}
    
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

networks:
  homelab:
    external: true
