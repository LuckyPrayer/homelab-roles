{# Backrest config.json - Generated by Ansible, do not edit manually #}
{# https://github.com/garethgeorge/backrest #}
{
  "modno": {{ backrest_config_modno | default(1) }},
  "version": 4,
  "instance": "{{ inventory_hostname }}",
  "repos": [
    {
      "id": "{{ backrest_b2_repo_id }}",
      "uri": "b2:{{ backrest_b2_bucket }}:{{ backrest_b2_repo_prefix }}",
      "password": "{{ backrest_restic_password }}",
      "env": [
        "B2_ACCOUNT_ID={{ backrest_b2_account_id }}",
        "B2_ACCOUNT_KEY={{ backrest_b2_account_key }}"
      ],
      "flags": [
        "--verbose"
      ],
      "prunePolicy": {
        "schedule": {
          "cron": "{{ backrest_prune_schedule }}",
          "clock": 3
        },
        "maxUnusedPercent": {{ backrest_prune_max_unused_percent | default(10) }}
      },
      "checkPolicy": {
        "schedule": {
          "cron": "{{ backrest_check_schedule }}",
          "clock": 3
        },
        "readDataSubsetPercent": {{ backrest_check_read_data_percent | default(5) }}
      },
{% if backrest_discord_webhook_url | default('') | length > 0 %}
      "hooks": [
        {
          "conditions": [
            "CONDITION_ANY_ERROR"
          ],
          "actionDiscord": {
            "webhookUrl": "{{ backrest_discord_webhook_url }}",
            "template": "‚ö†Ô∏è **Backrest Error**\nRepo: {{ '{{ .Repo.Id }}' }}\nTask: {{ '{{ .Task }}' }}\nTime: {{ '{{ .FormatTime .CurTime }}' }}\n{{ '{{ if .Error }}' }}Error: {{ '{{ .Error }}' }}{{ '{{ end }}' }}"
          }
        }
      ],
{% else %}
      "hooks": [],
{% endif %}
      "autoUnlock": true,
      "autoInitialize": true
    }
  ],
  "plans": [
{% for host in backrest_backup_hosts %}
    {
      "id": "{{ host.name }}",
      "repo": "{{ backrest_b2_repo_id }}",
      "paths": [
        "/backups/{{ host.name }}"
      ],
      "excludes": [
        "*.old.*/**",
        "*.tmp",
        "*.log"
      ],
      "schedule": {
        "cron": "{{ host.schedule | default(backrest_default_backup_schedule) }}",
        "clock": 1
      },
      "retention": {
        "policyTimeBucketed": {
          "hourly": {{ backrest_retention_hourly | default(0) }},
          "daily": {{ backrest_retention_daily | default(7) }},
          "weekly": {{ backrest_retention_weekly | default(4) }},
          "monthly": {{ backrest_retention_monthly | default(6) }},
          "yearly": {{ backrest_retention_yearly | default(0) }}
        }
      },
{% if backrest_discord_webhook_url | default('') | length > 0 %}
      "hooks": [
        {
          "conditions": [
            "CONDITION_SNAPSHOT_END"
          ],
          "actionDiscord": {
            "webhookUrl": "{{ backrest_discord_webhook_url }}",
            "template": "{{ '{{ if .Error }}' }}‚ùå{{ '{{ else }}' }}‚úÖ{{ '{{ end }}' }} **{{ host.name }}** backup {{ '{{ if .Error }}' }}failed{{ '{{ else }}' }}completed{{ '{{ end }}' }}\nPlan: {{ '{{ .Plan.Id }}' }} ‚ûù {{ '{{ .Repo.Id }}' }}\nTime: {{ '{{ .FormatTime .CurTime }}' }}{{ '{{ if .SnapshotStats }}' }}\nFiles: {{ '{{ .SnapshotStats.FilesNew }}' }} new, {{ '{{ .SnapshotStats.FilesChanged }}' }} changed\nAdded: {{ '{{ .SnapshotStats.DataAdded }}' }} bytes{{ '{{ end }}' }}{{ '{{ if .Error }}' }}\nError: {{ '{{ .Error }}' }}{{ '{{ end }}' }}"
          }
        },
        {
          "conditions": [
            "CONDITION_SNAPSHOT_ERROR"
          ],
          "onError": "ON_ERROR_RETRY_10MINUTES",
          "actionDiscord": {
            "webhookUrl": "{{ backrest_discord_webhook_url }}",
            "template": "üîÑ **Retrying** {{ host.name }} backup after error\nPlan: {{ '{{ .Plan.Id }}' }}\nError: {{ '{{ .Error }}' }}"
          }
        }
      ],
{% else %}
      "hooks": [],
{% endif %}
      "skipIfUnchanged": true
    }{{ "," if not loop.last else "" }}
{% endfor %}
  ],
  "auth": {
    "disabled": {{ backrest_auth_disabled | default(true) | lower }},
    "users": [
{% for user in backrest_auth_users | default([]) %}
      {
        "name": "{{ user.name }}",
        "passwordBcrypt": "{{ user.passwordBcrypt | default(user.password_bcrypt | default('')) }}"
      }{{ "," if not loop.last else "" }}
{% endfor %}
    ]
  }
}
