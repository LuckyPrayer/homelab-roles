version: "3.9"

services:
  traefik-proxy:
    image: {{ traefik_proxy_image }}
    container_name: traefik-proxy
    restart: unless-stopped
    network_mode: host
    command:
      - --api.dashboard={{ traefik_proxy_enable_dashboard | lower }}
{% if traefik_proxy_enable_dashboard %}
      - --api.insecure=false
{% endif %}
      - --entrypoints.web.address=:{{ traefik_proxy_http_port }}
      - --entrypoints.websecure.address=:{{ traefik_proxy_https_port }}
      - --entrypoints.traefik.address=:{{ traefik_proxy_api_port | default('8180') }}
      # Increase timeouts for large file uploads (e.g., Harbor image pushes)
      - --entrypoints.websecure.transport.respondingTimeouts.readTimeout=600s
      - --entrypoints.websecure.transport.respondingTimeouts.writeTimeout=600s
      - --entrypoints.websecure.transport.respondingTimeouts.idleTimeout=180s
      - --providers.file.filename=/config/proxy-rules.yml
      - --providers.file.watch=true
{% if traefik_proxy_use_dns_challenge %}
      - --certificatesresolvers.{{ traefik_proxy_cert_resolver }}.acme.dnschallenge=true
      - --certificatesresolvers.{{ traefik_proxy_cert_resolver }}.acme.dnschallenge.provider={{ traefik_proxy_dns_provider }}
      - --certificatesresolvers.{{ traefik_proxy_cert_resolver }}.acme.email={{ traefik_proxy_email }}
      - --certificatesresolvers.{{ traefik_proxy_cert_resolver }}.acme.storage=/letsencrypt/acme.json
{% endif %}
      - --log.level={{ traefik_proxy_log_level }}
      - --metrics.prometheus=true
    volumes:
      - {{ traefik_proxy_base_dir }}/acme.json:/letsencrypt/acme.json
      - {{ traefik_proxy_base_dir }}/config:/config:ro
{% if traefik_proxy_use_dns_challenge %}
    env_file:
      - {{ traefik_proxy_env_file }}
{% endif %}
    labels:
      - "traefik.enable=true"
{% if traefik_proxy_enable_dashboard %}
      - "traefik.http.routers.dashboard.rule=Host(`{{ traefik_proxy_dashboard_host }}`)"
      - "traefik.http.routers.dashboard.entrypoints=websecure"
      - "traefik.http.routers.dashboard.service=api@internal"
      - "traefik.http.routers.dashboard.tls=true"
{% if traefik_proxy_use_dns_challenge %}
      - "traefik.http.routers.dashboard.tls.certresolver={{ traefik_proxy_cert_resolver }}"
{% endif %}
{% endif %}
